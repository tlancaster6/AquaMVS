---
phase: 06-cli-qa-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/qa/issues-found.md
  - config.yaml
autonomous: false

must_haves:
  truths:
    - "aquamvs preprocess completes on real 13-camera videos and produces temporal median frames"
    - "aquamvs init generates a valid config.yaml from preprocessed image directory and calibration data"
    - "aquamvs export-refs produces undistorted reference images for all cameras"
  artifacts:
    - path: "preprocessed frame directories"
      provides: "5 frame sets x 13 cameras = 65 temporal median PNG images"
    - path: "config.yaml"
      provides: "Valid PipelineConfig YAML with camera-to-image mapping"
    - path: "output/reference_images/"
      provides: "13 undistorted reference PNGs for ROI mask creation"
  key_links:
    - from: "aquamvs preprocess"
      to: "preprocessed image directories"
      via: "temporal median filtering of video frames"
    - from: "aquamvs init"
      to: "config.yaml"
      via: "camera name regex matching against calibration"
    - from: "aquamvs export-refs"
      to: "reference_images/"
      via: "undistortion using calibration intrinsics"
---

<objective>
QA the first three CLI commands in dependency order: preprocess, init, and export-refs. These commands prepare the data pipeline — extracting temporal median frames from raw videos, generating a valid pipeline config, and exporting undistorted reference images for ROI mask creation.

Purpose: Validate the data preparation workflow end-to-end with real 13-camera capture data before running reconstruction.
Output: Preprocessed frames, valid config.yaml, and reference images ready for mask creation.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/aquamvs/cli.py
@src/aquamvs/preprocess.py
@src/aquamvs/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run preprocess, init, and export-refs commands</name>
  <files>.planning/qa/issues-found.md</files>
  <action>
Execute the first three CLI commands in order using real multi-camera data. Fix any blockers immediately.

**Step 1: Verify environment**
- Run `python -c "import aquamvs; print('OK')"` to confirm package imports
- Run `nvidia-smi` to check GPU availability and VRAM
- If import fails (e.g., missing natsort), install missing dependency and log in issues-found.md

**Step 2: Run preprocess**
- Locate the user's 13-camera video directory (ask if path unknown)
- Run: `aquamvs preprocess /path/to/videos --output-dir ./preprocessed --window 30 --framestep 3600 --format png`
  - framestep=3600 produces ~5 frames per 10-minute video at 30fps (1 frame every 2 minutes)
  - Adjust framestep based on actual FPS if different
- Verify output: check that preprocessed/ contains 5 frame directories, each with 13 PNG images
- If command fails, diagnose and fix the blocker

**Step 3: Run init**
- Run: `aquamvs init --video-dir ./preprocessed/frame_000000 --pattern "^([a-z0-9]+)\.png$" --calibration /path/to/calibration.json --output-dir ./output --config config.yaml`
  - Pattern extracts camera name from filename (e.g., "e3v82e0.png" -> "e3v82e0")
  - Adjust pattern if image filenames use different naming convention
- Verify: config.yaml exists and contains valid camera_video_map with all 13 (or 12 ring + 1 center) cameras matched
- Open config.yaml and review: check calibration_path is correct, camera names match expected IDs

**Step 4: Run export-refs**
- Run: `aquamvs export-refs config.yaml --frame 0`
- Verify: output/reference_images/ contains 13 undistorted PNG files
- Check file sizes are non-zero

**Step 5: Create issues tracking file**
- Create .planning/qa/issues-found.md with any non-blocking issues encountered
- If no issues, create the file with a "No issues found" header for later use

Any blocker encountered (import error, crash, empty output) should be fixed inline before proceeding.
  </action>
  <verify>
- `ls ./preprocessed/` shows 5 frame directories
- `ls ./preprocessed/frame_000000/*.png | wc -l` shows 13 (or expected camera count)
- `cat config.yaml` shows valid YAML with camera_video_map entries
- `ls ./output/reference_images/*.png | wc -l` shows 13
- All output files are non-zero size
  </verify>
  <done>preprocess produces temporal median frames, init generates valid config, export-refs outputs undistorted reference images — all with real data</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: User reviews outputs and creates ROI masks</name>
  <action>
Present results for user review. Three CLI commands were executed:
1. `aquamvs preprocess` — temporal median frames extracted from 13-camera videos
2. `aquamvs init` — config.yaml generated with camera-to-image mapping
3. `aquamvs export-refs` — undistorted reference images exported for mask drawing

User should verify:
1. Open a preprocessed frame image (e.g., preprocessed/frame_000000/e3v82e0.png) — verify fish/debris removal looks effective
2. Open config.yaml — verify camera names, paths, and calibration reference are correct
3. Open reference images in output/reference_images/ — verify undistortion looks correct (straight lines should be straight, no severe cropping)
4. **Create ROI masks**: Using preferred image editor, draw masks on the reference images. Save as binary grayscale PNGs (0=exclude, 255=include) in a masks/ directory, named exactly as {camera_name}.png (e.g., e3v82e0.png)
5. Edit config.yaml to add `mask_dir: /absolute/path/to/masks`

Resume signal: Type "approved" when masks are created and config.yaml is updated with mask_dir, or describe any issues found.
  </action>
  <verify>User confirms preprocessed images, config, and reference images look correct</verify>
  <done>User has reviewed outputs and created ROI masks for reconstruction</done>
</task>

</tasks>

<verification>
- All three commands (preprocess, init, export-refs) complete without errors
- Output files exist and are non-empty
- Config.yaml is valid and loadable by PipelineConfig.from_yaml()
- Reference images are visually correct (proper undistortion)
- User has created ROI masks and updated config with mask_dir
</verification>

<success_criteria>
- preprocess: 5 frame directories x 13 cameras = 65 temporal median PNGs
- init: config.yaml with all cameras matched to calibration
- export-refs: 13 undistorted reference PNGs in output/reference_images/
- User confirms visual quality and provides ROI masks for next phase
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-qa-execution/06-01-SUMMARY.md`
</output>
