---
phase: 06-cli-qa-execution
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - .planning/qa/issues-found.md
autonomous: false

must_haves:
  truths:
    - "aquamvs run works with video file input (not just preprocessed images)"
    - "aquamvs run completes a full LightGlue+full reconstruction on real data with CUDA"
    - "Pipeline produces depth maps, sparse cloud, fused cloud, and mesh for at least one frame"
    - "Output quality is visually plausible (depth gradients, surface continuity)"
  artifacts:
    - path: "output/frame_*/depth_maps/"
      provides: "Per-camera depth map NPZ files and colormap PNGs"
    - path: "output/frame_*/sparse_cloud_*.ply"
      provides: "Triangulated sparse point cloud"
    - path: "output/frame_*/fused_cloud_*.ply"
      provides: "Fused dense point cloud with outlier removal"
    - path: "output/frame_*/mesh_*.ply"
      provides: "Poisson surface reconstruction mesh"
  key_links:
    - from: "config.yaml"
      to: "aquamvs run"
      via: "PipelineConfig.from_yaml() loads and validates config"
    - from: "aquamvs run"
      to: "output directory"
      via: "Pipeline executes stages: undistort -> match -> depth -> fuse -> surface"
---

<objective>
QA the `aquamvs run` command with LightGlue+full execution path on real multi-camera data using CUDA. This is the primary reconstruction pipeline — the core product.

Purpose: Verify the full reconstruction pipeline produces valid outputs with real underwater capture data.
Output: Complete reconstruction outputs (depth maps, point clouds, mesh) for visual inspection.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cli-qa-execution/06-01-SUMMARY.md
@src/aquamvs/cli.py
@src/aquamvs/pipeline/runner.py
@src/aquamvs/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run LightGlue+full reconstruction pipeline</name>
  <files>.planning/qa/issues-found.md</files>
  <action>
Execute `aquamvs run` with LightGlue matcher in full mode on real data. Fix blockers inline.

**Step 1: Verify config is ready**
- Confirm config.yaml has mask_dir set (from Plan 01 checkpoint)
- Confirm config.yaml has matcher_type set to "lightglue" (default)
- Verify reconstruction section uses reasonable defaults or BALANCED quality preset
- Set runtime.device to "cuda" if not already

**Step 2: Test video input path (per locked decision)**
- Create a temporary config (config_video.yaml) that points camera_video_map entries
  directly at the raw video files (not the preprocessed image directories).
  Copy config.yaml and replace image directory paths with video file paths.
- Run: `aquamvs run config_video.yaml --sparse --device cuda`
  - This runs LightGlue sparse-only mode reading from video files, confirming the
    video input code path works end-to-end.
- Verify: command exits 0, sparse cloud PLY file is produced with > 0 points.
- If it fails, diagnose and fix the video reading path. Log any fixes in issues-found.md.
- Clean up: remove the video-based output directory (or rename it) so it doesn't
  interfere with the main image-based run below. Keep config_video.yaml for reference.

**Step 3: Run full pipeline from preprocessed images**
- Run: `aquamvs run config.yaml --device cuda`
- Monitor for CUDA OOM errors — if hit, reduce quality:
  - Try: set `reconstruction.depth_batch_size: 1` in config.yaml
  - Or: use FAST quality preset
  - Or: reduce `reconstruction.num_depths: 64`
- Monitor for import errors, path issues, or calibration mismatches
- Fix any blockers immediately

**Step 4: Verify outputs exist**
- Check output directory structure: `ls -lR output/frame_000000/`
- Verify depth maps: non-zero NPZ and PNG files in depth_maps/
- Verify sparse cloud: sparse_cloud_*.ply exists and has points
- Verify fused cloud: fused_cloud_*.ply exists (if fusion ran)
- Verify mesh: mesh_*.ply exists (if surface reconstruction ran)
- Count points in sparse cloud: `python -c "import open3d as o3d; pcd = o3d.io.read_point_cloud('output/frame_000000/sparse_cloud_frame_000000.ply'); print(len(pcd.points), 'points')"`

**Step 5: Log any non-blocking issues**
- Append to .planning/qa/issues-found.md

Note: Save the LightGlue output directory path — it will be used for benchmark comparison in Plan 03.
  </action>
  <verify>
- `aquamvs run` exits with code 0
- `ls output/frame_000000/depth_maps/*.npz` shows depth map files
- `ls output/frame_000000/*.ply` shows at least sparse cloud file
- Point count in sparse cloud > 0
  </verify>
  <done>LightGlue+full pipeline completes on real data with CUDA, producing depth maps, point clouds, and mesh</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: User reviews LightGlue reconstruction quality</name>
  <action>
Present reconstruction results for user review. LightGlue+full pipeline produced:
- Per-camera depth maps (NPZ + colormap PNG)
- Sparse triangulated point cloud
- Fused dense point cloud (with outlier removal)
- Poisson surface mesh

User should verify:
1. Open depth map PNGs (output/frame_000000/depth_maps/*_depth.png) — verify smooth depth gradients, no all-NaN maps, depth range is plausible (~1-2m for underwater surface)
2. Open sparse_cloud_*.ply in MeshLab or Open3D viewer — verify points cluster near expected surface, no extreme outliers
3. Open fused_cloud_*.ply — verify it's denser than sparse cloud, outlier removal is effective
4. Open mesh_*.ply — verify surface continuity, no disconnected patches, reasonable triangle count
5. Check if consistency maps were saved (if enabled in config)

Resume signal: Type "approved" if output quality is acceptable, or describe issues.
  </action>
  <verify>User confirms reconstruction quality is acceptable for v1.0</verify>
  <done>User has reviewed depth maps, point clouds, and mesh from LightGlue pipeline</done>
</task>

</tasks>

<verification>
- Pipeline completes without crashes on CUDA
- All expected output files are present and non-empty
- Visual quality is acceptable for v1.0 (functional, not publication-ready)
</verification>

<success_criteria>
- `aquamvs run` with LightGlue+full exits cleanly on real data
- Depth maps show plausible underwater surface depth
- Point clouds contain thousands+ points near expected surface
- Mesh is a connected surface (not scattered fragments)
- User confirms output quality is acceptable
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-qa-execution/06-02-SUMMARY.md`
</output>
