---
phase: 03-pipeline-decomposition-and-modularization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aquamvs/pipeline/__init__.py
  - src/aquamvs/pipeline/interfaces.py
  - src/aquamvs/pipeline/context.py
  - src/aquamvs/pipeline/builder.py
  - src/aquamvs/pipeline/helpers.py
autonomous: true

must_haves:
  truths:
    - "FrameSource protocol defines iterate_frames and context manager methods"
    - "CalibrationProvider protocol provides cameras, water_z, n_water, n_air, interface_normal"
    - "CalibrationProvider warns and falls back to n_air=n_water=1.0 when refractive params missing"
    - "PipelineContext and setup_pipeline (now build_pipeline_context) work from pipeline package"
    - "Existing imports from aquamvs.pipeline still resolve (package __init__.py re-exports)"
  artifacts:
    - path: "src/aquamvs/pipeline/interfaces.py"
      provides: "FrameSource and CalibrationProvider Protocol definitions"
      contains: "class FrameSource"
    - path: "src/aquamvs/pipeline/context.py"
      provides: "PipelineContext dataclass"
      contains: "class PipelineContext"
    - path: "src/aquamvs/pipeline/builder.py"
      provides: "build_pipeline_context function (formerly setup_pipeline)"
      contains: "def build_pipeline_context"
    - path: "src/aquamvs/pipeline/helpers.py"
      provides: "Helper functions (_should_viz, _save_consistency_map, etc.)"
      contains: "def _should_viz"
    - path: "src/aquamvs/pipeline/__init__.py"
      provides: "Package init with re-exports"
      contains: "PipelineContext"
  key_links:
    - from: "src/aquamvs/pipeline/builder.py"
      to: "src/aquamvs/pipeline/context.py"
      via: "imports PipelineContext, returns it"
      pattern: "from .context import PipelineContext"
    - from: "src/aquamvs/pipeline/__init__.py"
      to: "src/aquamvs/pipeline/builder.py"
      via: "re-exports build_pipeline_context as setup_pipeline"
      pattern: "from .builder import"
---

<objective>
Create the pipeline/ package scaffold with Protocol interfaces, context dataclass, builder, and helper functions extracted from the monolithic pipeline.py.

Purpose: Establish the package structure and foundational modules that stages and runner will import from. Define FrameSource and CalibrationProvider protocols per user decisions (REF-03, REF-04).

Output: `pipeline/` package with interfaces.py, context.py, builder.py, helpers.py, and __init__.py.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pipeline-decomposition-and-modularization/03-RESEARCH.md
@src/aquamvs/pipeline.py
@src/aquamvs/io.py
@src/aquamvs/calibration.py
@src/aquamvs/projection/protocol.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Protocol interfaces and pipeline package scaffold</name>
  <files>
    src/aquamvs/pipeline/__init__.py
    src/aquamvs/pipeline/interfaces.py
    src/aquamvs/pipeline/context.py
    src/aquamvs/pipeline/helpers.py
  </files>
  <action>
    **Delete** the old `src/aquamvs/pipeline.py` file (it will be replaced by the package directory).

    **Create `src/aquamvs/pipeline/` directory** with these modules:

    1. **interfaces.py** — Protocol definitions following the pattern in `projection/protocol.py`:
       - `FrameSource(Protocol)`: Methods `iterate_frames(start, stop, step) -> Iterator[tuple[int, dict[str, np.ndarray]]]`, `__enter__`, `__exit__`. This abstracts both `VideoSet` and `ImageDirectorySet`.
       - `CalibrationProvider(Protocol)`: Properties `cameras -> dict[str, CameraData]`, `water_z -> float`, `n_water -> float`, `n_air -> float`, `interface_normal -> torch.Tensor`, methods `ring_cameras -> list[str]`, `auxiliary_cameras -> list[str]`, `camera_positions() -> dict[str, torch.Tensor]`. The existing `CalibrationData` already satisfies this structurally — no changes to CalibrationData needed.
       - Helper function `ensure_refractive_params(provider: CalibrationProvider) -> CalibrationProvider` that checks if water_z/n_water are non-trivial; if missing or zero, logs a descriptive warning and returns a wrapper that sets n_air=n_water=1.0. Keep this simple — a thin wrapper or just modifying values, not a full adapter class.
       - Mark both protocols with `@runtime_checkable`.

    2. **context.py** — Move `PipelineContext` dataclass from pipeline.py (lines 227-243). Keep identical fields. Import CalibrationData, UndistortionData from calibration module, ProjectionModel from projection.protocol, PipelineConfig from config.

    3. **helpers.py** — Move these helper functions from pipeline.py:
       - `_should_viz()` (lines 50-65)
       - `_save_consistency_map()` (lines 68-98)
       - `_collect_height_maps()` (lines 101-155)
       - `_sparse_cloud_to_open3d()` (lines 158-224)
       Keep all imports they need. These are internal helpers used by stages/runner.

    4. **__init__.py** — Temporary init that re-exports `PipelineContext` from context. Will be expanded in Plan 03 when Pipeline class and runner are ready. For now, just enough to not break things:
       ```python
       from .context import PipelineContext
       ```
       Do NOT re-export setup_pipeline/process_frame/run_pipeline yet — those still need to be created in Plan 02/03.

    **Important:** After deleting pipeline.py, the package `from aquamvs.pipeline import ...` will resolve to the new package `__init__.py`. Temporarily this will break imports of `setup_pipeline`, `process_frame`, `run_pipeline`, and `_should_viz` — that's expected and will be fixed in subsequent plans.
  </action>
  <verify>
    - `python -c "from aquamvs.pipeline.interfaces import FrameSource, CalibrationProvider; print('OK')"`
    - `python -c "from aquamvs.pipeline.context import PipelineContext; print('OK')"`
    - `python -c "from aquamvs.pipeline.helpers import _should_viz; print('OK')"`
    - `python -c "from aquamvs.pipeline import PipelineContext; print('OK')"`
  </verify>
  <done>
    Pipeline package exists with interfaces.py (FrameSource + CalibrationProvider protocols), context.py (PipelineContext), helpers.py (4 helper functions), and __init__.py re-exporting PipelineContext. Old pipeline.py is deleted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create builder module (setup_pipeline extraction)</name>
  <files>
    src/aquamvs/pipeline/builder.py
    src/aquamvs/pipeline/__init__.py
  </files>
  <action>
    1. **Create `builder.py`** — Move `setup_pipeline()` function (lines 245-355 of old pipeline.py) into this module, renamed to `build_pipeline_context()` for clarity. The function:
       - Takes `PipelineConfig`, returns `PipelineContext`
       - Loads calibration via `load_calibration_data()`
       - Filters cameras to those with video
       - Computes undistortion maps
       - Creates RefractiveProjectionModel for each camera
       - Selects camera pairs
       - Loads ROI masks
       - Creates output directory and saves config copy

       Keep the function body identical to the original — this is a pure extraction, not a rewrite. All imports it needs (CalibrationData, compute_undistortion_maps, load_calibration_data, RefractiveProjectionModel, select_pairs, load_all_masks, PipelineConfig, PipelineContext) come from sibling aquamvs modules.

       Also export `setup_pipeline` as an alias: `setup_pipeline = build_pipeline_context` for backward compatibility during the transition.

    2. **Update `__init__.py`** — Add re-exports:
       ```python
       from .builder import build_pipeline_context, setup_pipeline
       from .context import PipelineContext
       ```

    **Note:** `process_frame` and `run_pipeline` are NOT yet created — they'll come in Plans 02 and 03. The __init__.py will be incomplete until then.
  </action>
  <verify>
    - `python -c "from aquamvs.pipeline.builder import build_pipeline_context; print('OK')"`
    - `python -c "from aquamvs.pipeline import setup_pipeline, PipelineContext; print('OK')"`
  </verify>
  <done>
    Builder module contains build_pipeline_context() (the former setup_pipeline), aliased as setup_pipeline for compatibility. Pipeline __init__.py re-exports both builder functions and PipelineContext.
  </done>
</task>

</tasks>

<verification>
1. All 5 new files exist under `src/aquamvs/pipeline/`
2. `python -c "from aquamvs.pipeline import PipelineContext, setup_pipeline"` succeeds
3. `python -c "from aquamvs.pipeline.interfaces import FrameSource, CalibrationProvider"` succeeds
4. `python -c "from aquamvs.pipeline.helpers import _should_viz, _save_consistency_map"` succeeds
5. No circular imports when importing any pipeline submodule
</verification>

<success_criteria>
- Pipeline package scaffold is complete with interfaces, context, builder, and helpers
- FrameSource and CalibrationProvider protocols are defined with correct method signatures
- CalibrationProvider includes refraction-naive fallback (n_air=n_water=1.0 with warning)
- PipelineContext and build_pipeline_context are importable from package
- setup_pipeline alias works for backward compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/03-pipeline-decomposition-and-modularization/03-01-SUMMARY.md`
</output>
