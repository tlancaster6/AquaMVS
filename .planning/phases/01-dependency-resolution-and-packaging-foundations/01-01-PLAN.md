---
phase: 01-dependency-resolution-and-packaging-foundations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - CHANGELOG.md
  - src/aquamvs/__init__.py
autonomous: false

must_haves:
  truths:
    - "LightGlue dependency strategy is decided and documented (vendor, fork, or prerequisite)"
    - "AquaCal dependency strategy is decided and documented (publish to PyPI, vendor, or prerequisite)"
    - "RoMa v2 install behavior is tested and workaround status is known"
    - "pyproject.toml has pinned dependency versions with minimum bounds"
    - "Wheel excludes tests, docs, and dev files"
    - "CHANGELOG.md exists with initial v0.1.0 entry"
  artifacts:
    - path: "pyproject.toml"
      provides: "Clean dependency specification with version pins, wheel exclusion, semantic-release config"
      contains: "include-package-data = false"
    - path: "CHANGELOG.md"
      provides: "Initial changelog with v0.1.0 entry"
      contains: "## v0.1.0"
  key_links:
    - from: "pyproject.toml"
      to: "src/aquamvs/__init__.py"
      via: "version string consistency"
      pattern: "version.*0\\.1\\.0"
---

<objective>
Resolve the three dependency blockers (LightGlue, RoMa, AquaCal), clean up pyproject.toml with proper version pins and wheel exclusion, and establish semantic versioning infrastructure.

Purpose: Without resolving dependency blockers, the package cannot be published to PyPI. Without version pins, installs are non-reproducible. This plan addresses all packaging foundations except CI/CD.

Output: Clean pyproject.toml ready for PyPI, CHANGELOG.md, dependency strategy decisions documented.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-dependency-resolution-and-packaging-foundations/01-RESEARCH.md
@pyproject.toml
</context>

<tasks>

<task type="checkpoint:decision" gate="blocking">
  <name>Task 1: Decide dependency strategies for LightGlue and AquaCal</name>
  <decision>How to handle LightGlue and AquaCal dependencies for PyPI distribution</decision>
  <context>
PyPI does NOT accept git+https:// direct URL dependencies in uploaded packages. LightGlue is not on PyPI.
AquaCal is currently a local editable dependency (pip install -e ../AquaCal).

Both must be resolved before AquaMVS can be published to PyPI.

**RoMa status:** The current pyproject.toml lists `romav2` directly. The dataclasses>=0.8 metadata bug may or may not cause install failures on Python 3.10+. Testing needed but can proceed in parallel.
  </context>
  <options>
    <option id="lightglue-vendor">
      <name>Vendor LightGlue into src/aquamvs/_vendor/lightglue/</name>
      <pros>No external dependency, full control, guaranteed PyPI compatibility, zero install friction for users</pros>
      <cons>Must maintain vendored copy, ~2K lines to copy, must track upstream changes manually</cons>
    </option>
    <option id="lightglue-fork">
      <name>Fork LightGlue to PyPI as aquamvs-lightglue</name>
      <pros>Clean pip install, separate package, can add patches</pros>
      <cons>Must maintain PyPI package, name squatting concerns, extra publishing overhead</cons>
    </option>
    <option id="lightglue-prereq">
      <name>Document LightGlue as manual prerequisite</name>
      <pros>No maintenance burden, upstream changes get picked up</pros>
      <cons>Bad UX — user must run extra pip install command before installing AquaMVS, breaks "pip install aquamvs" goal</cons>
    </option>
    <option id="aquacal-pypi">
      <name>Publish AquaCal to PyPI, reference as standard dependency</name>
      <pros>Clean dependency, both packages independently useful, standard workflow</pros>
      <cons>Must publish AquaCal first (blocking), ongoing PyPI maintenance for AquaCal</cons>
    </option>
    <option id="aquacal-prereq">
      <name>Document AquaCal as manual prerequisite</name>
      <pros>No AquaCal publishing work needed, simpler Phase 1</pros>
      <cons>Users must install AquaCal manually, breaks clean "pip install aquamvs" flow</cons>
    </option>
    <option id="aquacal-vendor">
      <name>Vendor AquaCal interfaces into AquaMVS</name>
      <pros>Single package install</pros>
      <cons>Duplicates code, creates maintenance burden, breaks clean separation between calibration and reconstruction</cons>
    </option>
  </options>
  <files>.planning/phases/01-dependency-resolution-and-packaging-foundations/01-01-SUMMARY.md</files>
  <action>Present dependency strategy options to user and wait for decision. Test RoMa v2 install in parallel: run `pip install --dry-run romav2` to check if dataclasses metadata bug causes failure on current Python version. Document chosen strategies in the plan summary.</action>
  <verify>User has selected one LightGlue strategy and one AquaCal strategy.</verify>
  <done>Dependency strategies for LightGlue and AquaCal are decided. RoMa v2 install behavior is known.</done>
  <resume-signal>Select one option for LightGlue and one for AquaCal. For example: "lightglue-vendor, aquacal-pypi"</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Clean up pyproject.toml, create CHANGELOG.md, and configure wheel exclusion</name>
  <files>pyproject.toml, CHANGELOG.md, src/aquamvs/__init__.py</files>
  <action>
**pyproject.toml updates:**
1. Add minimum version bounds to all unpinned dependencies:
   - `torch>=2.0.0`
   - `kornia>=0.7.0`
   - `open3d>=0.18.0`
   - `numpy>=1.24.0`
   - `scipy>=1.10.0`
   - `pyyaml>=6.0`
   - `matplotlib>=3.7.0`
2. Implement the LightGlue and AquaCal dependency strategy chosen in Task 1:
   - If vendoring LightGlue: Remove `lightglue @ git+https://...` from dependencies. Copy LightGlue source into `src/aquamvs/_vendor/lightglue/` and update imports.
   - If LightGlue as prerequisite: Remove from dependencies, add install instruction comment.
   - If AquaCal publish: Add `aquacal>=0.1.0` to dependencies.
   - If AquaCal as prerequisite: Add comment documenting manual install.
3. Add wheel exclusion configuration:
   ```toml
   [tool.setuptools.packages.find]
   where = ["src"]
   exclude = ["tests*", "docs*"]

   [tool.setuptools]
   include-package-data = false
   ```
4. Add `python-semantic-release` config:
   ```toml
   [tool.semantic_release]
   version_toml = ["pyproject.toml:project.version"]
   branch = "main"
   build_command = "pip install build && python -m build"

   [tool.semantic_release.commit_parser_options]
   allowed_tags = ["feat", "fix", "docs", "refactor", "perf", "test", "chore"]
   minor_tags = ["feat"]
   patch_tags = ["fix", "perf"]
   ```
5. Pin LightGlue to specific commit hash if keeping as git dependency for development (even if removing from pyproject.toml dependencies for distribution):
   - Use `edb2b83` (v0.2 release) as pin target
6. Add `python-semantic-release` to dev dependencies.
7. Test RoMa v2 install: run `pip install --dry-run romav2` in current environment to check if it resolves. If it fails due to dataclasses, add a comment in pyproject.toml explaining the --no-deps workaround. If it succeeds, note that no workaround is needed.

**CHANGELOG.md:**
Create with initial entry:
```markdown
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/),
and this project adheres to [Semantic Versioning](https://semver.org/).

## v0.1.0 — Initial Release

### Added
- Refractive projection model with Snell's law ray casting
- Sparse feature extraction via LightGlue (SuperPoint, ALIKED, DISK)
- Dense matching via RoMa v2
- Plane-sweep stereo with NCC/SSIM cost metrics
- Depth map fusion with confidence weighting
- Surface reconstruction (Poisson, BPA, heightfield)
- Best-view vertex coloring
- CLI with init, run, export-refs, and benchmark commands
- YAML-based pipeline configuration
- Benchmark suite with HTML reports
```

**src/aquamvs/__init__.py:**
Ensure `__version__ = "0.1.0"` is present and matches pyproject.toml.
  </action>
  <verify>
1. `python -m build` succeeds (builds wheel and sdist)
2. Wheel contents do not include tests/, docs/, or .planning/:
   `python -c "import zipfile; [print(n) for n in zipfile.ZipFile('dist/aquamvs-0.1.0-py3-none-any.whl').namelist() if 'test' in n or 'doc' in n or 'planning' in n]"` produces no output
3. `python -c "import aquamvs; print(aquamvs.__version__)"` prints "0.1.0"
  </verify>
  <done>
pyproject.toml has minimum version bounds on all dependencies, dependency blockers are resolved per user decision, wheel builds clean without test/doc/dev files, CHANGELOG.md exists with v0.1.0 entry, __version__ matches pyproject.toml.
  </done>
</task>

</tasks>

<verification>
1. `python -m build` completes without errors
2. Built wheel contains only aquamvs/ package files (no tests, docs, planning)
3. CHANGELOG.md exists with v0.1.0 entry
4. pyproject.toml has version bounds on all dependencies
5. Dependency strategy for LightGlue and AquaCal is implemented per user decision
</verification>

<success_criteria>
- pyproject.toml is ready for PyPI upload (no git URLs in dependencies if vendoring/prereq chosen)
- All dependencies have minimum version bounds
- Wheel is clean (no dev files)
- Versioning infrastructure (CHANGELOG.md, semantic-release config) is in place
- Dependency decisions are documented
</success_criteria>

<output>
After completion, create `.planning/phases/01-dependency-resolution-and-packaging-foundations/01-01-SUMMARY.md`
</output>
