---
phase: 01-dependency-resolution-and-packaging-foundations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - CHANGELOG.md
  - src/aquamvs/__init__.py
autonomous: false

must_haves:
  truths:
    - "LightGlue is pinned as git dependency to commit hash edb2b83"
    - "RoMa v2 is pinned as git dependency to user's fork at tlancaster6/RoMaV2"
    - "AquaCal is declared as normal PyPI dependency (aquacal>=X.Y)"
    - "PyTorch is NOT declared as a dependency — import-time check raises clear error if missing"
    - "pyproject.toml has pinned dependency versions with minimum bounds"
    - "Wheel excludes tests, docs, and dev files"
    - "CHANGELOG.md exists with initial v0.1.0 entry"
  artifacts:
    - path: "pyproject.toml"
      provides: "Clean dependency specification with version pins, wheel exclusion, semantic-release config"
      contains: "include-package-data = false"
    - path: "CHANGELOG.md"
      provides: "Initial changelog with v0.1.0 entry"
      contains: "## v0.1.0"
    - path: "src/aquamvs/__init__.py"
      provides: "Version string and import-time torch check"
      contains: "import torch"
  key_links:
    - from: "pyproject.toml"
      to: "src/aquamvs/__init__.py"
      via: "version string consistency"
      pattern: "version.*0\\.1\\.0"
    - from: "src/aquamvs/__init__.py"
      to: "torch"
      via: "import-time check with clear error message"
      pattern: "ImportError"
---

<objective>
Implement the locked dependency strategy (git pins for LightGlue and RoMa, PyPI for AquaCal, torch as user-managed prerequisite with import-time check), clean up pyproject.toml with proper version pins and wheel exclusion, and establish semantic versioning infrastructure.

Purpose: Without resolving dependency blockers, the package cannot be published to PyPI. Without version pins, installs are non-reproducible. This plan addresses all packaging foundations except CI/CD.

Output: Clean pyproject.toml, CHANGELOG.md, import-time torch check, and a user decision on PyPI distribution strategy for git-URL dependencies.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-dependency-resolution-and-packaging-foundations/01-RESEARCH.md
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update pyproject.toml with locked dependency decisions, create CHANGELOG.md, add torch import check</name>
  <files>pyproject.toml, CHANGELOG.md, src/aquamvs/__init__.py</files>
  <action>
**pyproject.toml updates:**

1. **Dependencies — implement locked decisions directly (no conditional branches):**
   - `kornia>=0.7.0`
   - `open3d>=0.18.0`
   - `numpy>=1.24.0`
   - `scipy>=1.10.0`
   - `pyyaml>=6.0`
   - `matplotlib>=3.7.0`
   - `aquacal>=0.1.0` (per user decision: normal PyPI dependency)
   - `lightglue @ git+https://github.com/cvg/LightGlue.git@edb2b83` (per user decision: git dependency pin to v0.2 release commit)
   - `romav2 @ git+https://github.com/tlancaster6/RoMaV2.git@<resolve-hash>` (per user decision: git dependency pin to user's fork; resolve the current HEAD hash of the fork's main branch at execution time)
   - Do NOT add `torch` or `torchvision` as dependencies (per user decision: user-managed prerequisites)

2. **Wheel exclusion configuration:**
   ```toml
   [tool.setuptools.packages.find]
   where = ["src"]
   exclude = ["tests*", "docs*"]

   [tool.setuptools]
   include-package-data = false
   ```

3. **Semantic-release config:**
   ```toml
   [tool.semantic_release]
   version_toml = ["pyproject.toml:project.version"]
   branch = "main"
   build_command = "pip install build && python -m build"

   [tool.semantic_release.commit_parser_options]
   allowed_tags = ["feat", "fix", "docs", "refactor", "perf", "test", "chore"]
   minor_tags = ["feat"]
   patch_tags = ["fix", "perf"]
   ```

4. **Add `python-semantic-release` to dev dependencies.**

5. **Remove any existing `romav2` (bare) or `lightglue` entries** that don't match the locked git pin format above.

**src/aquamvs/__init__.py — add import-time torch check:**

Add at the TOP of the file (before any other imports):
```python
try:
    import torch
except ImportError:
    raise ImportError(
        "PyTorch is required but not installed. "
        "Install it from https://pytorch.org/get-started/locally/ "
        "choosing the appropriate CUDA version for your system. "
        "Example: pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121"
    ) from None
```

Ensure `__version__ = "0.1.0"` is present and matches pyproject.toml.

**CHANGELOG.md:**
Create with initial entry:
```markdown
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/),
and this project adheres to [Semantic Versioning](https://semver.org/).

## v0.1.0 — Initial Release

### Added
- Refractive projection model with Snell's law ray casting
- Sparse feature extraction via LightGlue (SuperPoint, ALIKED, DISK)
- Dense matching via RoMa v2
- Plane-sweep stereo with NCC/SSIM cost metrics
- Depth map fusion with confidence weighting
- Surface reconstruction (Poisson, BPA, heightfield)
- Best-view vertex coloring
- CLI with init, run, export-refs, and benchmark commands
- YAML-based pipeline configuration
- Benchmark suite with HTML reports
```
  </action>
  <verify>
1. `python -m build` succeeds (builds wheel and sdist)
2. Wheel contents do not include tests/, docs/, or .planning/:
   `python -c "import zipfile; [print(n) for n in zipfile.ZipFile('dist/aquamvs-0.1.0-py3-none-any.whl').namelist() if 'test' in n or 'doc' in n or 'planning' in n]"` produces no output
3. `python -c "import aquamvs; print(aquamvs.__version__)"` prints "0.1.0"
4. `grep -c "torch" pyproject.toml` returns 0 (torch is NOT in dependencies)
5. `grep "import torch" src/aquamvs/__init__.py` confirms import-time check exists
6. `grep "lightglue.*git+https.*edb2b83" pyproject.toml` confirms LightGlue git pin
7. `grep "romav2.*git+https.*tlancaster6" pyproject.toml` confirms RoMa fork pin
8. `grep "aquacal" pyproject.toml` confirms AquaCal as standard dependency
  </verify>
  <done>
pyproject.toml implements all locked dependency decisions (LightGlue git pin, RoMa fork git pin, AquaCal PyPI, no torch). Import-time torch check raises clear error pointing to install docs. Wheel builds clean without test/doc/dev files. CHANGELOG.md exists with v0.1.0 entry. __version__ matches pyproject.toml.
  </done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <name>Task 2: Resolve PyPI vs git-URL distribution conflict</name>
  <decision>How to handle PyPI uploads given that LightGlue and RoMa use git+https:// URLs which PyPI rejects</decision>
  <context>
The locked decisions specify git dependency pins for LightGlue (commit edb2b83) and RoMa v2 (user's fork). These work perfectly for development installs (`pip install -e .` and `pip install git+https://...`).

However, **PyPI rejects packages with `git+https://` direct URL dependencies** in uploaded wheels (PEP 440 direct references are forbidden in metadata uploaded to PyPI). This means `pip install aquamvs` from PyPI will NOT work with git-URL dependencies in pyproject.toml.

This is a genuine conflict between the locked git-pin decision and the Phase 1 success criterion "User can run `pip install aquamvs` from PyPI."

The git pins are implemented in Task 1 for development use. This checkpoint asks how to handle PyPI distribution specifically.
  </context>
  <options>
    <option id="prereq-docs">
      <name>Document LightGlue and RoMa as install prerequisites</name>
      <pros>No extra maintenance, git pins stay in pyproject.toml for dev installs, users get exact versions via documented install commands</pros>
      <cons>Users must run 2-3 pip install commands before `pip install aquamvs`. For PyPI upload, git URLs must be moved out of [project.dependencies] into a separate requirements-dev.txt or similar.</cons>
    </option>
    <option id="vendor-both">
      <name>Vendor LightGlue and publish RoMa fork to PyPI</name>
      <pros>Clean `pip install aquamvs` works from PyPI, zero user friction</pros>
      <cons>LightGlue vendoring adds ~2K lines to maintain. Publishing RoMa fork to PyPI requires a new package name (e.g., aquamvs-romav2) or waiting for upstream merge.</cons>
    </option>
    <option id="fork-to-pypi">
      <name>Publish both as forks to PyPI (aquamvs-lightglue, aquamvs-romav2)</name>
      <pros>Clean pip install, standard PyPI dependencies, can patch freely</pros>
      <cons>Two extra PyPI packages to maintain, potential name confusion, must track upstream</cons>
    </option>
  </options>
  <action>Present the PyPI git-URL conflict to the user with the three options above. This is a newly discovered conflict between the locked git-pin decision and PyPI policy — not a re-asking of previously decided questions. The user's choice will determine whether Plan 01-02 (CI/CD) needs a modified publish workflow and whether additional packaging work is needed.</action>
  <verify>User has selected one of the three distribution strategies.</verify>
  <done>PyPI distribution strategy for git-URL dependencies is decided. The chosen approach is documented in the plan summary for Plan 01-02 to consume.</done>
  <resume-signal>Select: prereq-docs, vendor-both, or fork-to-pypi</resume-signal>
</task>

</tasks>

<verification>
1. `python -m build` completes without errors
2. Built wheel contains only aquamvs/ package files (no tests, docs, planning)
3. CHANGELOG.md exists with v0.1.0 entry
4. pyproject.toml has version bounds on all dependencies
5. torch is NOT in pyproject.toml dependencies
6. Import-time torch check exists in src/aquamvs/__init__.py
7. LightGlue and RoMa are pinned to specific git commits
8. AquaCal is a standard PyPI dependency
9. PyPI distribution strategy is decided
</verification>

<success_criteria>
- pyproject.toml implements all locked dependency decisions exactly
- torch is user-managed with import-time check providing clear install instructions
- All non-torch dependencies have minimum version bounds
- Wheel is clean (no dev files)
- Versioning infrastructure (CHANGELOG.md, semantic-release config) is in place
- PyPI distribution conflict is resolved with user decision
</success_criteria>

<output>
After completion, create `.planning/phases/01-dependency-resolution-and-packaging-foundations/01-01-SUMMARY.md`
</output>
