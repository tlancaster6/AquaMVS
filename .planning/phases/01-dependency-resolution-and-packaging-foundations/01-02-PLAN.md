---
phase: 01-dependency-resolution-and-packaging-foundations
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .github/workflows/test.yml
  - .github/workflows/publish.yml
autonomous: true

must_haves:
  truths:
    - "Tests run automatically on push and pull request to main"
    - "CI tests on both Windows and Linux"
    - "CI tests on Python 3.10, 3.11, and 3.12"
    - "Publish workflow builds wheel and uploads to PyPI on tagged release"
    - "Publish workflow uses Trusted Publishing (OIDC), not API tokens"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "Matrix test workflow (2 OS x 3 Python versions)"
      contains: "pytest"
    - path: ".github/workflows/publish.yml"
      provides: "Build and publish workflow with TestPyPI and PyPI stages"
      contains: "pypa/gh-action-pypi-publish"
  key_links:
    - from: ".github/workflows/test.yml"
      to: "pyproject.toml"
      via: "pip install -e .[dev]"
      pattern: "pip install.*dev"
    - from: ".github/workflows/publish.yml"
      to: "pyproject.toml"
      via: "python -m build"
      pattern: "python -m build"
---

<objective>
Create GitHub Actions CI/CD workflows for automated testing across platforms and automated publishing to PyPI via Trusted Publishing.

Purpose: CI ensures tests pass on Windows and Linux before merging. Automated publishing eliminates manual upload errors and uses secure OIDC authentication. These workflows are required for PKG-06 (CI on multiple platforms) and PKG-01 (publishable to PyPI).

Output: Two GitHub Actions workflow files — test.yml and publish.yml.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-dependency-resolution-and-packaging-foundations/01-RESEARCH.md
@.planning/phases/01-dependency-resolution-and-packaging-foundations/01-CONTEXT.md — locked dependency decisions
@.planning/phases/01-dependency-resolution-and-packaging-foundations/01-01-SUMMARY.md — PyPI distribution strategy decision from Plan 01 Task 2
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test workflow with platform matrix</name>
  <files>.github/workflows/test.yml</files>
  <action>
Create `.github/workflows/test.yml` with:

1. **Triggers:** push to main, pull_request to main
2. **Matrix:** os: [ubuntu-latest, windows-latest] x python-version: ["3.10", "3.11", "3.12"]
3. **Strategy:** fail-fast: false (don't cancel other jobs if one fails)
4. **Steps:**
   - actions/checkout@v4
   - actions/setup-python@v5 with python-version and pip cache
   - Install PyTorch CPU-only: `pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu`
   - Install package + dev deps: `pip install --upgrade pip setuptools wheel && pip install -e ".[dev]"`
     (This installs LightGlue and RoMa from git URLs in pyproject.toml, AquaCal from PyPI — all per locked decisions)
   - **If Plan 01 Task 2 chose prereq-docs strategy:** Read 01-01-SUMMARY.md. If git deps were moved out of pyproject.toml for PyPI compatibility, add explicit install steps for LightGlue and RoMa git URLs before `pip install -e ".[dev]"`
   - Run tests: `pytest tests/ --cov=aquamvs --cov-report=xml --cov-report=term-missing -m "not slow"`
   - Skip CUDA tests gracefully (they auto-skip via pytest.mark.skipif)

**Important CI considerations:**
- Do NOT install torch with CUDA in CI (CPU-only is fine for tests, saves time/space)
- Use `pip cache` via actions/setup-python for faster installs
- Set `PYTHONUNBUFFERED=1` for real-time test output
  </action>
  <verify>
Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/test.yml'))"` succeeds.
Check that matrix includes both OS and all 3 Python versions.
  </verify>
  <done>
test.yml exists with correct matrix (2 OS x 3 Python), triggers on push/PR to main, installs dependencies including prerequisite packages, runs pytest with coverage. Note: actual CI execution cannot be verified locally — the workflow will be validated on the first push/PR to main after merging. YAML syntax validation confirms structural correctness.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create publish workflow with Trusted Publishing</name>
  <files>.github/workflows/publish.yml</files>
  <action>
Create `.github/workflows/publish.yml` with:

1. **Trigger:** push tags matching `v*` (e.g., v0.1.0, v1.0.0)
2. **Job 1 - build:**
   - runs-on: ubuntu-latest
   - Checkout, setup Python 3.12
   - Install build tools: `pip install build check-manifest`
   - Build: `python -m build`
   - Upload dist/ as artifact
3. **Job 2 - publish-testpypi:**
   - needs: build
   - runs-on: ubuntu-latest
   - environment: testpypi
   - permissions: id-token: write
   - Download artifact, publish with pypa/gh-action-pypi-publish@release/v1 to TestPyPI
4. **Job 3 - publish-pypi:**
   - needs: publish-testpypi
   - runs-on: ubuntu-latest
   - environment: pypi (requires manual approval in GitHub)
   - permissions: id-token: write
   - Download artifact, publish with pypa/gh-action-pypi-publish@release/v1

**Notes:**
- TestPyPI step validates package before PyPI upload
- PyPI environment should be configured with required reviewers for manual gate
- Trusted Publishing (OIDC) eliminates API token management
- User will need to configure Trusted Publishing on PyPI/TestPyPI after workflow is created (documented in summary)
  </action>
  <verify>
Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/publish.yml'))"` succeeds.
Check that publish job uses `id-token: write` permission and `pypa/gh-action-pypi-publish` action.
  </verify>
  <done>
publish.yml exists with three-stage pipeline (build -> TestPyPI -> PyPI), uses Trusted Publishing (OIDC), triggers on version tags.
  </done>
</task>

</tasks>

<verification>
1. Both workflow files exist and have valid YAML syntax
2. test.yml matrix covers Windows + Linux and Python 3.10-3.12
3. publish.yml uses Trusted Publishing (id-token: write)
4. publish.yml has TestPyPI validation step before PyPI
5. Dependency installation steps reflect locked decisions (git pins for LightGlue/RoMa, PyPI for AquaCal), adapted per PyPI distribution strategy from Plan 01 Task 2
6. CI workflow execution verified on first push/PR to main — if tests fail in CI, create a follow-up task to fix platform-specific issues
</verification>

<success_criteria>
- CI test workflow configured for 6 matrix combinations (2 OS x 3 Python) — YAML syntax validated locally, actual execution verified on first push/PR to main
- Publish workflow automates the full build-test-publish pipeline
- No API tokens or secrets required (Trusted Publishing only)
- All YAML files pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/01-dependency-resolution-and-packaging-foundations/01-02-SUMMARY.md`
</output>
