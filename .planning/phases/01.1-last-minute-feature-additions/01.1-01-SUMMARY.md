---
phase: 01.1-last-minute-feature-additions
plan: 01
subsystem: CLI utilities
tags: [preprocessing, mesh-export, video, temporal-median, format-conversion]

dependency_graph:
  requires: [cv2, numpy, open3d]
  provides: [preprocess, export-mesh]
  affects: [cli.py, surface.py, config.py]

tech_stack:
  added: []
  patterns: [circular-buffer-median, quadric-decimation, lazy-imports]

key_files:
  created:
    - src/aquamvs/preprocess.py
  modified:
    - src/aquamvs/cli.py
    - src/aquamvs/surface.py
    - src/aquamvs/config.py
    - src/aquamvs/__init__.py

decisions:
  - Lazy imports in CLI handlers to avoid loading cv2/Open3D at parse time
  - Circular buffer for memory-efficient temporal median filtering
  - Auto-compute normals for STL export (Open3D requirement)
  - Batch mode uses glob for directory scanning, processes all videos
  - Format detection from output_path suffix (no explicit format mapping)

metrics:
  duration_min: 5
  completed_date: 2026-02-14
  tasks_completed: 2
  files_created: 1
  files_modified: 4
---

# Phase 01.1 Plan 01: Temporal Median Preprocessing and Mesh Export

Temporal median preprocessing for fish/debris removal and mesh format conversion utilities with simplification support.

## Deviations from Plan

None - plan executed exactly as written.

## Tasks Completed

### Task 1: Create temporal median preprocessing module and CLI command
- **Commit:** 8039d32
- **Files:** src/aquamvs/preprocess.py, src/aquamvs/cli.py
- Created `process_video_temporal_median()` with circular buffer for windowed median computation
- Created `process_batch()` for single-file and directory batch processing
- Added `aquamvs preprocess` CLI subcommand with PNG and MP4 output modes
- Lazy import of cv2/numpy to avoid CLI parse-time overhead
- Output naming preserves traceability: `{video_stem}/frame_000000.png` or `{video_stem}_median.mp4`

### Task 2: Add mesh export CLI command and mesh simplification
- **Commit:** 5a00086
- **Files:** src/aquamvs/surface.py, src/aquamvs/config.py, src/aquamvs/cli.py, src/aquamvs/__init__.py
- Added `simplify_mesh()` using Open3D's quadric decimation with target face count
- Added `export_mesh()` with format conversion support (OBJ, STL, GLTF, GLB)
- Added `target_faces` field to `SurfaceConfig` for pipeline-level mesh simplification
- Added `aquamvs export-mesh` CLI subcommand with single-file and batch modes
- Integrated simplification into `reconstruct_surface()` pipeline
- STL export auto-computes normals (Open3D requirement), warns about color loss

## Verification Results

All verification tests passed:
- `python -c "from aquamvs.preprocess import process_video_temporal_median, process_batch"` - SUCCESS
- `python -c "from aquamvs.surface import export_mesh, simplify_mesh"` - SUCCESS
- `python -c "from aquamvs.config import SurfaceConfig; sc = SurfaceConfig(); assert sc.target_faces is None"` - SUCCESS
- `aquamvs preprocess --help` - Shows all arguments correctly
- `aquamvs export-mesh --help` - Shows all arguments correctly
- `aquamvs --help` - Lists both new commands (preprocess, export-mesh)

## Self-Check: PASSED

### Created Files
- FOUND: src/aquamvs/preprocess.py

### Modified Files
- FOUND: src/aquamvs/cli.py
- FOUND: src/aquamvs/surface.py
- FOUND: src/aquamvs/config.py
- FOUND: src/aquamvs/__init__.py

### Commits
- FOUND: 8039d32 (Task 1: temporal median preprocessing)
- FOUND: 5a00086 (Task 2: mesh export and simplification)

## Technical Notes

### Preprocessing Design
- **Circular buffer:** FIFO queue maintains window of N frames for median computation without storing entire video
- **BGR preservation:** OpenCV's native format maintained throughout (no RGB conversion)
- **Framestep optimization:** Median only computed when `frame_idx % framestep == 0` to reduce computation
- **Output formats:** PNG sequence for frame-by-frame use, MP4 video for preview/visualization

### Mesh Export Design
- **Format detection:** Extension-based (`.obj`, `.stl`, `.gltf`, `.glb`)
- **STL requirements:** Auto-computes normals if missing (Open3D `write_triangle_mesh` fails silently without them)
- **GLB vs GLTF:** Both supported; GLB is binary (smaller, single file)
- **Batch mode:** Glob `*.ply` in input directory, convert all to specified format

### Pipeline Integration
- **SurfaceConfig.target_faces:** Optional simplification applied after reconstruction, before mesh save
- **Lazy imports:** CLI handlers import heavy modules (cv2, Open3D) only when needed, not at CLI parse time
- **Backward compatibility:** `target_faces = None` preserves existing behavior (no simplification)

## Success Criteria Met

- [x] `aquamvs preprocess` accepts video file/directory input and supports PNG/MP4 output
- [x] `aquamvs export-mesh` converts PLY meshes to OBJ, STL, GLTF, GLB with optional simplification
- [x] SurfaceConfig.target_faces enables pipeline-level mesh simplification
- [x] All existing CLI commands still work (no regressions)
- [x] No new dependencies added (uses existing OpenCV, Open3D, NumPy)
