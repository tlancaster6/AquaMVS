---
phase: 01.1-last-minute-feature-additions
plan: 02
subsystem: Pipeline enhancements
tags: [outlier-removal, consistency-maps, image-input, point-cloud, diagnostics]

dependency_graph:
  requires: [open3d, matplotlib, cv2]
  provides: [outlier-removal-config, consistency-map-persistence, image-directory-input]
  affects: [pipeline.py, config.py, io.py, cli.py]

tech_stack:
  added: []
  patterns: [statistical-outlier-removal, viridis-colormap, input-type-detection]

key_files:
  created:
    - src/aquamvs/io.py
  modified:
    - src/aquamvs/config.py
    - src/aquamvs/pipeline.py
    - src/aquamvs/cli.py
    - tests/test_cli.py

decisions:
  - Outlier removal enabled by default (nb_neighbors=20, std_ratio=2.0)
  - Consistency map colormap normalized by number of source cameras, not per-frame max
  - Viridis colormap for perceptual uniformity and colorblind accessibility
  - Auto-detection of input type (image directory vs video file) based on path.is_dir()
  - ImageDirectorySet validates matching filenames and frame counts across cameras

metrics:
  duration_min: 12
  completed_date: 2026-02-14
  tasks_completed: 2
  files_created: 1
  files_modified: 4
---

# Phase 01.1 Plan 02: Pipeline Enhancements

Statistical outlier removal on fused point clouds (on by default), consistency map output persistence (opt-in), and image directory input support for preprocessed frames.

## Deviations from Plan

None - plan executed exactly as written.

## Tasks Completed

### Task 1: Add statistical outlier removal and image directory input support
- **Commit:** 99d8f0f
- **Files:** src/aquamvs/config.py, src/aquamvs/pipeline.py, src/aquamvs/io.py, src/aquamvs/cli.py, tests/test_cli.py
- Added `OutlierRemovalConfig` dataclass with enabled=True, nb_neighbors=20, std_ratio=2.0 defaults
- Integrated outlier removal into pipeline after fusion, before surface reconstruction
- Applied in both full pipeline path (after fused_pcd) and sparse path (after sparse cloud)
- Created `io.py` module with `ImageDirectorySet` adapter class
- `ImageDirectorySet` provides VideoSet-compatible interface: iterate_frames(), frame_count property, context manager
- `detect_input_type()` auto-detects directories vs files, validates consistency
- Updated `run_pipeline()` to auto-detect input type and use appropriate context manager
- Updated `export_refs_command` in CLI to support image directory input
- Updated tests to mock `detect_input_type` for VideoSet patches

### Task 2: Add consistency map persistence
- **Commit:** b0a6d16
- **Files:** src/aquamvs/pipeline.py
- Added `save_consistency_maps` field to `OutputConfig` (defaults to False, opt-in)
- Created `_save_consistency_map()` helper function in pipeline.py
- Saves consistency maps as both NPZ (programmatic analysis) and PNG (visual inspection)
- PNG uses viridis colormap normalized by number of source cameras (not per-frame max)
- Consistency maps saved in `consistency_maps/` subdirectory alongside depth maps
- Only applies to full pipeline path where `filter_all_depth_maps()` produces consistency counts
- Skipped in sparse path and RoMa path (no geometric consistency filtering)

## Verification Results

All verification tests passed:
- `python -c "from aquamvs.config import OutlierRemovalConfig, PipelineConfig; p = PipelineConfig(); assert p.outlier_removal.enabled is True"` - SUCCESS
- `python -c "from aquamvs.io import ImageDirectorySet, detect_input_type"` - SUCCESS
- `python -c "from aquamvs.pipeline import run_pipeline"` - SUCCESS
- `python -c "from aquamvs.config import OutputConfig; o = OutputConfig(); assert o.save_consistency_maps is False"` - SUCCESS
- `python -c "from aquamvs.pipeline import _save_consistency_map"` - SUCCESS
- `pytest tests/test_config.py tests/test_cli.py -x -q` - 96 passed in 5.13s

## Self-Check: PASSED

### Created Files
- FOUND: src/aquamvs/io.py

### Modified Files
- FOUND: src/aquamvs/config.py
- FOUND: src/aquamvs/pipeline.py
- FOUND: src/aquamvs/cli.py
- FOUND: tests/test_cli.py

### Commits
- FOUND: 99d8f0f (Task 1: statistical outlier removal and image directory input support)
- FOUND: b0a6d16 (Task 2: consistency map persistence)

## Technical Notes

### Outlier Removal Design
- **Algorithm:** Open3D's `remove_statistical_outlier()` with nb_neighbors=20, std_ratio=2.0
- **Integration points:** After fusion (full path) and after sparse triangulation (sparse path)
- **Logging:** Reports original count, removed count, and percentage for each frame
- **Backward compatibility:** Existing configs without outlier_removal section use defaults (enabled=True)

### Image Directory Input Design
- **Validation:** All cameras must have same number of images with matching filenames (sorted order)
- **Supported formats:** PNG, JPG, JPEG, TIFF, TIF (case-insensitive extensions)
- **Interface compatibility:** `iterate_frames(start, stop, step)` matches VideoSet signature exactly
- **Use case:** Consuming preprocessed frames from temporal median or external tools without video re-encoding

### Consistency Map Persistence Design
- **Dual output:** NPZ for programmatic analysis, PNG for visual inspection
- **Colormap:** Viridis (perceptually uniform, colorblind-accessible)
- **Normalization:** By number of source cameras (not per-frame max) for consistent color meaning across frames
- **Location:** `{output_dir}/frame_NNNNNN/consistency_maps/{camera_name}.{npz,png}`
- **Interpretation:** Pixel value = number of source cameras that agree on depth at that pixel

## Success Criteria Met

- [x] Statistical outlier removal runs by default on fused point clouds before surface reconstruction
- [x] User can disable outlier removal via config flag (outlier_removal.enabled = false)
- [x] Consistency maps saved as colormapped PNG + NPZ when save_consistency_maps is true
- [x] Consistency map colormap normalized by number of source cameras (not per-frame max)
- [x] Pipeline accepts image directories as input (auto-detects directory vs video file)
- [x] Image directory input validates matching filenames across cameras
- [x] All changes are backward compatible with existing config files
- [x] No new dependencies added (uses existing Open3D, Matplotlib, OpenCV, NumPy)
