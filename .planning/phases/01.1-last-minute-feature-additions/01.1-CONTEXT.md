# Phase 01.1: Last-Minute Feature Additions - Context

**Gathered:** 2026-02-14
**Status:** Ready for planning

<domain>
## Phase Boundary

Add high-impact, low-code features before V1 release that significantly improve usability without requiring architectural changes. Five features: temporal median preprocessing, mesh export formats, mesh simplification, statistical outlier removal on fused clouds, and consistency map output. Also includes adding image input support to the main pipeline (companion to temporal median).

</domain>

<decisions>
## Implementation Decisions

### Temporal Median Preprocessing (Fish Removal)
- Standalone CLI utility, not integrated into the reconstruction pipeline
- Accepts video files (MP4/AVI) as input, extracts frames internally via OpenCV
- Accepts single file or directory of files (batch mode)
- Output defaults: sibling directory for directory input, same directory for file input
- Windowed median with two parameters: **framestep** (which frames get output) and **window** (number of surrounding frames in median)
- Sensible default window size (~30 frames) with config override
- Camera-agnostic — no awareness of camera IDs or rig layout
- Outputs median image (static background), not difference image
- Dual output mode: PNG image series or MP4 video
- Output naming should preserve traceability to input video

### Image Input Support for Main Pipeline
- Add ability for the main `aquamvs` pipeline to consume pre-extracted image directories (not just video files)
- Enables direct consumption of temporal-median-preprocessed frames
- Auto-detect: if input path is video, use video reader; if directory of images, use images directly

### Mesh Export Formats
- Separate CLI command: `aquamvs export-mesh input.ply --format obj`
- Supported formats: OBJ, STL, GLTF/GLB (in addition to existing PLY)
- Single file and batch mode (--input-dir to convert all PLY files in a directory)
- Vertex colors only — no UV unwrapping or texture baking

### Mesh Simplification
- Available in two places: pipeline config (`target_faces` in SurfaceConfig) and `export-mesh` command (`--simplify N`)
- Target face count as the specification method (e.g., `--simplify 50000`)
- Uses Open3D quadric decimation

### Statistical Outlier Removal on Fused Clouds
- On by default with sensible parameters — user can disable via config
- Applied after fusion, before surface reconstruction
- Uses Open3D `remove_statistical_outlier()`

### Consistency Maps
- Opt-in via OutputConfig flag (`save_consistency_maps`)
- Dual output: colormapped PNG for quick inspection + NPZ arrays for programmatic analysis
- Saved alongside depth maps in the same output directory

### Claude's Discretion
- Default window size for temporal median
- Statistical outlier removal parameters (nb_neighbors, std_ratio)
- Consistency map colormap choice
- Output naming conventions for median preprocessing
- GLTF export details (binary GLB vs text GLTF)

</decisions>

<specifics>
## Specific Ideas

- Temporal median is designed to remove transient objects (fish, debris, bubbles) from underwater video frames before reconstruction
- The tool should feel like a standalone preprocessing utility that happens to pair well with AquaMVS but could be used independently
- Image input support closes the gap between the median preprocessor output and the pipeline input

</specifics>

<deferred>
## Deferred Ideas

- Config presets (fast/balanced/accurate) — discussed but deferred from this phase, good candidate for Phase 2 (Config and API Cleanup)
- Texture mapping / UV unwrapping for mesh export — future enhancement
- Rotating preview video export (turntable animation) — future visualization feature
- Ground truth comparison CLI command — future evaluation feature
- Resume/checkpoint mechanism — future pipeline feature

</deferred>

---

*Phase: 01.1-last-minute-feature-additions*
*Context gathered: 2026-02-14*
