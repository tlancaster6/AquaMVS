---
phase: 01.1-last-minute-feature-additions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aquamvs/preprocess.py
  - src/aquamvs/surface.py
  - src/aquamvs/config.py
  - src/aquamvs/cli.py
  - src/aquamvs/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can run `aquamvs preprocess video.mp4` and get temporal median PNG frames output"
    - "User can run `aquamvs preprocess video.mp4 --format mp4` and get a median-filtered MP4 video"
    - "User can run `aquamvs preprocess /path/to/videos/` for batch processing of all videos in a directory"
    - "User can run `aquamvs export-mesh input.ply --format obj` to convert PLY to OBJ"
    - "User can run `aquamvs export-mesh input.ply --format stl` to convert PLY to STL (with normals computed)"
    - "User can run `aquamvs export-mesh input.ply --format glb` to convert PLY to GLB"
    - "User can run `aquamvs export-mesh input.ply --simplify 50000` to decimate mesh before export"
    - "Mesh simplification is available in pipeline via `target_faces` in SurfaceConfig"
  artifacts:
    - path: "src/aquamvs/preprocess.py"
      provides: "Temporal median computation and video/image I/O"
    - path: "src/aquamvs/cli.py"
      provides: "preprocess and export-mesh subcommand definitions and dispatch"
    - path: "src/aquamvs/surface.py"
      provides: "export_mesh() and simplify_mesh() utility functions"
    - path: "src/aquamvs/config.py"
      provides: "SurfaceConfig.target_faces field"
  key_links:
    - from: "src/aquamvs/cli.py"
      to: "src/aquamvs/preprocess.py"
      via: "preprocess_command() calls process_video_temporal_median()"
    - from: "src/aquamvs/cli.py"
      to: "src/aquamvs/surface.py"
      via: "export_mesh_command() calls export_mesh()"
    - from: "src/aquamvs/surface.py"
      to: "open3d"
      via: "simplify_quadric_decimation() and write_triangle_mesh()"
---

<objective>
Add two new standalone CLI tools to AquaMVS: temporal median preprocessing for fish/debris removal from underwater video, and mesh export with format conversion and simplification.

Purpose: These tools extend AquaMVS usability before V1 release. Temporal median removes transient objects (fish, debris, bubbles) from video frames. Mesh export enables downstream consumption of reconstructions in standard 3D formats. Both are standalone utilities that don't require pipeline refactoring.

Output: Two new CLI commands (`aquamvs preprocess`, `aquamvs export-mesh`), a new `preprocess.py` module, updated `surface.py` with export/simplification utilities, and updated `config.py` with `target_faces` field.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-last-minute-feature-additions/01.1-RESEARCH.md
@src/aquamvs/cli.py
@src/aquamvs/config.py
@src/aquamvs/surface.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create temporal median preprocessing module and CLI command</name>
  <files>
    src/aquamvs/preprocess.py
    src/aquamvs/cli.py
  </files>
  <action>
Create `src/aquamvs/preprocess.py` with the temporal median preprocessing logic:

1. **`process_video_temporal_median(video_path, output_dir, window, framestep, output_format)`** function:
   - Accept a single video file path (Path), output directory (Path), window size (int, default 30), framestep (int, default 1), output format ("png" or "mp4")
   - Use `cv2.VideoCapture` to read frames. Use a circular buffer (list with FIFO pop) of `window` frames.
   - When buffer is full and `frame_idx % framestep == 0`, compute `np.median(np.array(buffer), axis=0).astype(np.uint8)` and output.
   - For PNG mode: write each median frame as `frame_{frame_idx:06d}.png` in output_dir.
   - For MP4 mode: use `cv2.VideoWriter` with `mp4v` fourcc, fps = original_fps / framestep, write to `{video_stem}_median.mp4`.
   - Log progress: processed frame count and output frame count.
   - Keep BGR channel order throughout (OpenCV convention) -- do NOT convert to RGB.
   - Raise `RuntimeError` if video fails to open.
   - Return number of output frames produced.

2. **`process_batch(input_path, output_dir, window, framestep, output_format)`** function:
   - If `input_path` is a file: process that single video, output_dir defaults to `input_path.parent` if None.
   - If `input_path` is a directory: iterate over all video files (extensions: .mp4, .avi, .mkv, .mov), process each. Output_dir defaults to `input_path.parent / f"{input_path.name}_median"` if None.
   - For each video, create a subdirectory named after the video stem inside output_dir.
   - Output naming preserves traceability: `{output_dir}/{video_stem}/frame_000000.png` for PNG mode, `{output_dir}/{video_stem}_median.mp4` for MP4 mode.

3. **Add `preprocess` subcommand to `cli.py`**:
   - Add subparser `preprocess` with arguments:
     - `input` (positional, type=Path): Video file or directory of videos
     - `--output-dir` (type=Path, default=None): Output directory (auto-computed if omitted)
     - `--window` (type=int, default=30): Median window size in frames
     - `--framestep` (type=int, default=1): Output every Nth frame
     - `--format` (type=str, choices=["png", "mp4"], default="png"): Output format
   - Add dispatch in `main()`: `elif args.command == "preprocess": preprocess_command(args)`
   - `preprocess_command(args)` should call `process_batch()` and print a summary.
   - Import `preprocess` lazily inside the command handler (not at module top) to avoid loading cv2/numpy at CLI parse time.

Module docstring for preprocess.py: `"""Temporal median preprocessing for fish and debris removal from underwater video."""`
  </action>
  <verify>
    - `python -c "from aquamvs.preprocess import process_video_temporal_median, process_batch"` succeeds
    - `aquamvs preprocess --help` shows usage with all arguments
    - `python -c "from aquamvs.cli import main"` succeeds (no import errors)
  </verify>
  <done>
    - preprocess.py exists with process_video_temporal_median() and process_batch() functions
    - CLI `aquamvs preprocess` subcommand is registered and dispatches correctly
    - Both PNG and MP4 output modes are implemented
    - Windowed median uses circular buffer for memory efficiency
    - Output naming preserves traceability to input video
  </done>
</task>

<task type="auto">
  <name>Task 2: Add mesh export CLI command and mesh simplification</name>
  <files>
    src/aquamvs/surface.py
    src/aquamvs/config.py
    src/aquamvs/cli.py
    src/aquamvs/__init__.py
  </files>
  <action>
1. **Add to `src/aquamvs/surface.py`**:

   a. **`simplify_mesh(mesh, target_faces)`** function:
      - Accept `o3d.geometry.TriangleMesh` and `target_faces: int`.
      - Call `mesh.simplify_quadric_decimation(target_number_of_triangles=target_faces)`.
      - Log original face count, target, and actual result count.
      - If actual > target * 1.1, log a warning that simplification fell short.
      - Return the simplified mesh.

   b. **`export_mesh(input_path, output_path, simplify=None)`** function:
      - Load mesh from `input_path` using `o3d.io.read_triangle_mesh(str(input_path))`.
      - Validate mesh has vertices; raise `ValueError` if empty.
      - If `simplify` is not None, call `simplify_mesh(mesh, simplify)`.
      - Determine format from `output_path` suffix. If STL and mesh lacks vertex normals, call `mesh.compute_vertex_normals()`.
      - Call `o3d.io.write_triangle_mesh(str(output_path), mesh)`. Check return value; raise `RuntimeError` if False.
      - Log success with format and face count.

   c. **Update `reconstruct_surface()`** (or the pipeline integration point): After mesh reconstruction, if `config.target_faces` is not None, apply `simplify_mesh()`.

2. **Update `src/aquamvs/config.py`**:
   - Add `target_faces: int | None = None` to `SurfaceConfig` dataclass. Docstring: "Target triangle count for mesh simplification (None = no simplification)."

3. **Add `export-mesh` subcommand to `cli.py`**:
   - Add subparser `export-mesh` with arguments:
     - `input` (positional, type=Path): Input PLY mesh file
     - `--format` (type=str, required=True, choices=["obj", "stl", "gltf", "glb"]): Output format
     - `--simplify` (type=int, default=None): Target face count for simplification
     - `--input-dir` (type=Path, default=None): Batch mode - convert all PLY files in directory (mutually exclusive with positional input)
     - `--output-dir` (type=Path, default=None): Output directory for batch mode (defaults to same directory as input)
   - Handle single file: output path = input path with new extension.
   - Handle batch mode: glob `*.ply` in input-dir, convert each.
   - Add dispatch in `main()`.
   - Import `export_mesh` from `surface` lazily inside the command handler.

4. **Update `src/aquamvs/__init__.py`**: Add `preprocess` to imports if appropriate (only if there are public API exports from preprocess.py -- at minimum ensure preprocess.py is importable).

Format support matrix: OBJ (.obj), STL (.stl, needs normals), GLTF (.gltf), GLB (.glb). Use binary GLB as the GLTF variant (smaller, single file).

STL caveat: Always call `mesh.compute_vertex_normals()` before writing STL -- Open3D returns False silently without normals. Also warn user that STL does not support vertex colors.
  </action>
  <verify>
    - `python -c "from aquamvs.surface import export_mesh, simplify_mesh"` succeeds
    - `aquamvs export-mesh --help` shows usage with all arguments
    - `python -c "from aquamvs.config import SurfaceConfig; sc = SurfaceConfig(); assert sc.target_faces is None"` succeeds
  </verify>
  <done>
    - surface.py has export_mesh() and simplify_mesh() functions
    - SurfaceConfig has target_faces field (default None)
    - CLI `aquamvs export-mesh` subcommand supports OBJ, STL, GLTF, GLB formats
    - Batch mode (--input-dir) converts all PLY files in a directory
    - STL export auto-computes normals, warns about no vertex colors
    - Pipeline applies simplification when target_faces is set in config
  </done>
</task>

</tasks>

<verification>
1. Both new CLI commands show help text: `aquamvs preprocess --help` and `aquamvs export-mesh --help`
2. All imports work: `python -c "from aquamvs.preprocess import process_video_temporal_median; from aquamvs.surface import export_mesh, simplify_mesh"`
3. SurfaceConfig backward compatible: `python -c "from aquamvs.config import SurfaceConfig; s = SurfaceConfig(); assert s.target_faces is None"`
4. Existing CLI commands still work: `aquamvs --help` shows all commands including new ones
</verification>

<success_criteria>
- `aquamvs preprocess` accepts video file/directory input and supports PNG/MP4 output
- `aquamvs export-mesh` converts PLY meshes to OBJ, STL, GLTF, GLB with optional simplification
- SurfaceConfig.target_faces enables pipeline-level mesh simplification
- All existing tests pass (no regressions)
- No new dependencies added (uses existing OpenCV, Open3D, NumPy)
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-last-minute-feature-additions/01.1-01-SUMMARY.md`
</output>
