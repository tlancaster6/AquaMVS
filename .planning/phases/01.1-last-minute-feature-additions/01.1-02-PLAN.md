---
phase: 01.1-last-minute-feature-additions
plan: 02
type: execute
wave: 2
depends_on: ["01.1-01"]
files_modified:
  - src/aquamvs/config.py
  - src/aquamvs/pipeline.py
  - src/aquamvs/cli.py
  - src/aquamvs/io.py
autonomous: true

must_haves:
  truths:
    - "Statistical outlier removal runs by default on fused point clouds before surface reconstruction"
    - "User can disable outlier removal via config flag (outlier_removal.enabled = false)"
    - "Consistency maps are saved as colormapped PNG + NPZ when save_consistency_maps is true"
    - "Consistency map colormap is normalized by number of source cameras (not per-frame max)"
    - "Pipeline accepts image directories as input (auto-detects directory vs video file)"
    - "Image directory input validates matching filenames across cameras"
  artifacts:
    - path: "src/aquamvs/config.py"
      provides: "OutlierRemovalConfig dataclass, OutputConfig.save_consistency_maps field"
    - path: "src/aquamvs/pipeline.py"
      provides: "Outlier removal integration, consistency map persistence, image input detection"
    - path: "src/aquamvs/io.py"
      provides: "ImageDirectorySet adapter class for image directory input"
    - path: "src/aquamvs/cli.py"
      provides: "Updated run command handling for image directory auto-detection"
  key_links:
    - from: "src/aquamvs/pipeline.py"
      to: "src/aquamvs/config.py"
      via: "OutlierRemovalConfig controls removal in pipeline, OutputConfig.save_consistency_maps controls persistence"
    - from: "src/aquamvs/pipeline.py"
      to: "src/aquamvs/io.py"
      via: "ImageDirectorySet used when camera_video_map values are directories"
    - from: "src/aquamvs/pipeline.py"
      to: "open3d"
      via: "pcd.remove_statistical_outlier() for outlier removal"
---

<objective>
Integrate three pipeline enhancements into AquaMVS: statistical outlier removal on fused point clouds, consistency map output persistence, and image directory input support.

Purpose: Outlier removal improves reconstruction quality by default. Consistency maps give users diagnostic insight into multi-view agreement. Image input support enables consumption of preprocessed frames (from temporal median or external tools) without video re-encoding.

Output: Updated pipeline with outlier removal (on by default), opt-in consistency map saving (PNG + NPZ), and auto-detection of image directories vs video files for input.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-last-minute-feature-additions/01.1-RESEARCH.md
@.planning/phases/01.1-last-minute-feature-additions/01.1-01-SUMMARY.md
@src/aquamvs/pipeline.py
@src/aquamvs/config.py
@src/aquamvs/fusion.py
@src/aquamvs/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add statistical outlier removal and image directory input support</name>
  <files>
    src/aquamvs/config.py
    src/aquamvs/pipeline.py
    src/aquamvs/io.py
    src/aquamvs/cli.py
  </files>
  <action>
1. **Add `OutlierRemovalConfig` to `src/aquamvs/config.py`**:
   ```python
   @dataclass
   class OutlierRemovalConfig:
       """Configuration for statistical outlier removal on fused point clouds.

       Applied after fusion, before surface reconstruction.
       Uses Open3D remove_statistical_outlier().

       Attributes:
           enabled: Enable statistical outlier removal (on by default).
           nb_neighbors: Number of neighbors for mean distance calculation.
           std_ratio: Standard deviation ratio threshold.
       """
       enabled: bool = True
       nb_neighbors: int = 20
       std_ratio: float = 2.0
   ```
   - Add `outlier_removal: OutlierRemovalConfig` to `PipelineConfig` with default factory.
   - Add it to `from_yaml()` parsing: extract "outlier_removal" from data, build via `_build_dataclass`.
   - No validation needed (bool + numeric fields with sensible defaults).

2. **Integrate outlier removal into `src/aquamvs/pipeline.py`**:
   - After `fuse_depth_maps()` produces `fused_pcd` and before `reconstruct_surface()`, add:
     ```python
     if config.outlier_removal.enabled and len(fused_pcd.points) > 0:
         original_count = len(fused_pcd.points)
         fused_pcd, _ = fused_pcd.remove_statistical_outlier(
             nb_neighbors=config.outlier_removal.nb_neighbors,
             std_ratio=config.outlier_removal.std_ratio,
         )
         removed = original_count - len(fused_pcd.points)
         logger.info(
             "Frame %d: removed %d outliers (%.1f%%) from fused cloud",
             frame_idx, removed, removed / original_count * 100,
         )
     ```
   - Apply this in BOTH code paths that call `reconstruct_surface()`: the full pipeline path (around line 856) and the sparse pipeline path (around line 610). Check both `process_frame()` and `_process_frame_full()` or equivalent functions.
   - Note: `remove_statistical_outlier()` returns `(filtered_pcd, inlier_indices)` -- use only the first element.

3. **Create `src/aquamvs/io.py`** with `ImageDirectorySet` adapter:
   ```python
   """I/O adapters for image directory and video input sources."""
   ```
   - Class `ImageDirectorySet`:
     - `__init__(self, image_dirs: dict[str, str])`: Accept dict mapping camera_name to directory path.
     - `_validate_and_index(self)`: For each camera dir, glob for images (`*.png`, `*.jpg`, `*.jpeg`, `*.tiff`), sort by filename. Verify all cameras have same file count and same filenames. Raise `ValueError` on mismatch.
     - `__enter__` / `__exit__`: Context manager (no-op, no resources to release).
     - `iterate_frames(self, start=0, stop=None, step=1)`: Yield `(frame_idx, dict[str, np.ndarray])` matching `VideoSet.iterate_frames()` signature. Read images with `cv2.imread()`.
     - Property `frame_count`: Total number of frames available.

   - Function `detect_input_type(camera_map: dict[str, str]) -> str`:
     - Check first value in camera_map. If it's a directory path, return "images". If it's a file path, return "video".
     - Validate all values are consistent (all directories or all files). Raise `ValueError` if mixed.

4. **Update `src/aquamvs/pipeline.py`** to use `ImageDirectorySet`:
   - At the point where `VideoSet(config.camera_video_map)` is used (around line 975 in `run_pipeline`), add auto-detection:
     ```python
     from .io import detect_input_type, ImageDirectorySet
     input_type = detect_input_type(config.camera_video_map)
     if input_type == "images":
         context_manager = ImageDirectorySet(config.camera_video_map)
     else:
         context_manager = VideoSet(config.camera_video_map)
     with context_manager as videos:
         ...
     ```
   - Also update `export_refs_command` in cli.py and any other place that uses `VideoSet(config.camera_video_map)`.

5. **Update `src/aquamvs/cli.py`**: No new subcommands needed. The `run` command auto-detects input type via the pipeline changes above. For `export-refs`, also use `detect_input_type` to support image directory input.
  </action>
  <verify>
    - `python -c "from aquamvs.config import OutlierRemovalConfig, PipelineConfig; p = PipelineConfig(); assert p.outlier_removal.enabled is True"`
    - `python -c "from aquamvs.io import ImageDirectorySet, detect_input_type"`
    - `python -c "from aquamvs.pipeline import run_pipeline"` (no import errors)
    - Existing tests pass: `pytest tests/ -x -q` (no regressions from config/pipeline changes)
  </verify>
  <done>
    - OutlierRemovalConfig exists with enabled=True, nb_neighbors=20, std_ratio=2.0 defaults
    - Pipeline applies outlier removal after fusion by default
    - ImageDirectorySet provides VideoSet-compatible interface for image directories
    - Pipeline auto-detects image directory vs video file input
    - Backward compatible: existing configs without outlier_removal section use defaults
  </done>
</task>

<task type="auto">
  <name>Task 2: Add consistency map persistence</name>
  <files>
    src/aquamvs/config.py
    src/aquamvs/pipeline.py
  </files>
  <action>
1. **Update `OutputConfig` in `src/aquamvs/config.py`**:
   - Add `save_consistency_maps: bool = False` field. Docstring: "Save consistency maps as colormapped PNG + NPZ alongside depth maps. Opt-in."

2. **Add consistency map saving to `src/aquamvs/pipeline.py`**:
   - After `filter_all_depth_maps()` returns results (around line 807-810), if `config.output.save_consistency_maps` is True:
     ```python
     if config.output.save_consistency_maps:
         consistency_dir = frame_dir / "consistency_maps"
         consistency_dir.mkdir(parents=True, exist_ok=True)
         for cam_name, (_, _, consistency) in filtered.items():
             _save_consistency_map(
                 consistency=consistency,
                 output_stem=consistency_dir / cam_name,
                 max_value=len(ctx.pairs[cam_name]),  # Number of source cameras
             )
         logger.info("Frame %d: saved consistency maps for %d cameras", frame_idx, len(filtered))
     ```

   - Add helper function `_save_consistency_map(consistency, output_stem, max_value)`:
     ```python
     def _save_consistency_map(
         consistency: torch.Tensor,
         output_stem: Path,
         max_value: int,
     ) -> None:
         """Save consistency map as NPZ and colormapped PNG.

         Args:
             consistency: Consistency count map (H, W), int32.
             output_stem: Output path stem (without extension).
             max_value: Maximum consistency value for normalization
                 (number of source cameras for this reference view).
         """
         import cv2
         from matplotlib import cm

         consistency_np = consistency.cpu().numpy()

         # NPZ for programmatic analysis
         np.savez_compressed(
             str(output_stem.with_suffix(".npz")),
             consistency=consistency_np,
         )

         # Colormapped PNG for visual inspection
         # Normalize by number of source cameras, not per-frame max
         cmap = cm.get_cmap("viridis")
         normalized = consistency_np.astype(float) / max(max_value, 1)
         colored = cmap(normalized)  # (H, W, 4) RGBA float [0, 1]
         colored_bgr = (colored[:, :, :3][:, :, ::-1] * 255).astype(np.uint8)
         cv2.imwrite(str(output_stem.with_suffix(".png")), colored_bgr)
     ```

   - **Key detail**: Use `viridis` colormap (perceptually uniform, colorblind-accessible). Normalize by `max_value` (number of source cameras), NOT by `consistency.max()`. This ensures consistent color meaning across frames and cameras.

   - **Integration points**: This needs to happen in the `full` pipeline path where `filter_all_depth_maps()` is called. The `sparse` path and the `roma` path (which skips consistency filtering) do not produce consistency maps -- that's expected.

   - Need to determine what `ctx.pairs[cam_name]` looks like to get source camera count. Look at how pairs are structured in `pipeline.py` (likely a dict mapping ref_name to list of source camera names). Use `len(pairs[cam_name])` or equivalent.

3. **Ensure backward compatibility**:
   - Default `save_consistency_maps = False` means no behavior change for existing configs.
   - The `from_yaml()` parser already handles new fields gracefully via `_build_dataclass` (missing fields get defaults).
  </action>
  <verify>
    - `python -c "from aquamvs.config import OutputConfig; o = OutputConfig(); assert o.save_consistency_maps is False"`
    - `python -c "from aquamvs.pipeline import _save_consistency_map"` (function exists)
    - Existing tests pass: `pytest tests/ -x -q`
  </verify>
  <done>
    - OutputConfig.save_consistency_maps field exists, defaults to False
    - Consistency maps saved as both NPZ (programmatic) and PNG (visual) when enabled
    - PNG uses viridis colormap normalized by source camera count
    - Saved alongside depth maps in consistency_maps/ subdirectory
    - No behavior change for existing configs (opt-in only)
  </done>
</task>

</tasks>

<verification>
1. Config backward compatibility: `python -c "from aquamvs.config import PipelineConfig; p = PipelineConfig(); assert p.outlier_removal.enabled; assert not p.output.save_consistency_maps"`
2. Image input auto-detection: `python -c "from aquamvs.io import detect_input_type; assert detect_input_type({'cam1': 'video.mp4'}) == 'video'"`
3. Existing YAML configs load without error (new fields use defaults)
4. All existing tests pass: `pytest tests/ -x -q`
</verification>

<success_criteria>
- Statistical outlier removal is on by default and removes outliers from fused point clouds
- Consistency maps (PNG + NPZ) are saved when save_consistency_maps is enabled
- Pipeline auto-detects image directory input and uses ImageDirectorySet adapter
- All changes are backward compatible with existing config files
- No new dependencies (uses existing Open3D, Matplotlib, OpenCV, NumPy)
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-last-minute-feature-additions/01.1-02-SUMMARY.md`
</output>
