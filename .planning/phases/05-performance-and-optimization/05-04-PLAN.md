---
phase: 05-performance-and-optimization
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - src/aquamvs/config.py
  - src/aquamvs/dense/plane_sweep.py
  - tests/test_dense/test_plane_sweep.py
  - tests/test_config.py
autonomous: true

must_haves:
  truths:
    - "Quality presets (fast/balanced/quality) modify multiple config parameters with a single setting"
    - "Plane sweep cost volume construction is optimized with depth batching for better GPU utilization"
    - "At least one measured bottleneck has a verified optimization"
  artifacts:
    - path: "src/aquamvs/config.py"
      provides: "QualityPreset enum and apply_preset method on PipelineConfig"
      contains: "QualityPreset"
    - path: "src/aquamvs/dense/plane_sweep.py"
      provides: "Batched cost volume construction"
      contains: "batch_size"
  key_links:
    - from: "src/aquamvs/config.py"
      to: "QualityPreset"
      via: "Preset applies predefined values to ReconstructionConfig + SparseMatchingConfig"
      pattern: "apply_preset|PRESET_CONFIGS"
    - from: "src/aquamvs/dense/plane_sweep.py"
      to: "build_cost_volume"
      via: "Depth batching optimization in inner loop"
      pattern: "batch_size|batch_start"
---

<objective>
Implement quality presets and optimize plane sweep stereo based on profiling results.

Purpose: BEN-03 requires at least one optimization targeting a measured bottleneck. Plane sweep (build_cost_volume with grid_sample) is the identified primary bottleneck per user decision and research. Quality presets let users choose speed/accuracy tradeoffs per user decision.

Output: QualityPreset system in config, batched depth plane sweep optimization, verified performance improvement.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-performance-and-optimization/05-RESEARCH.md
@.planning/phases/05-performance-and-optimization/05-03-SUMMARY.md
@src/aquamvs/config.py
@src/aquamvs/dense/plane_sweep.py
@src/aquamvs/dense/cost.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Quality presets</name>
  <files>
    src/aquamvs/config.py
    tests/test_config.py
  </files>
  <action>
    Add quality preset system to config.py per user decision (configurable quality presets: fast/balanced/quality):

    Add `QualityPreset` enum (str, Enum):
    - FAST = "fast"
    - BALANCED = "balanced"
    - QUALITY = "quality"

    Add `PRESET_CONFIGS` dict mapping each preset to parameter overrides (Claude's discretion on specific values per CONTEXT.md):
    - FAST: num_depths=64, window_size=7, max_keypoints=1024, voxel_size=0.002, poisson_depth=8, depth_batch_size=8
    - BALANCED: num_depths=128, window_size=11, max_keypoints=2048, voxel_size=0.001, poisson_depth=9, depth_batch_size=4
    - QUALITY: num_depths=256, window_size=15, max_keypoints=4096, voxel_size=0.0005, poisson_depth=10, depth_batch_size=1

    Add `quality_preset: QualityPreset | None = None` field to PipelineConfig.

    Add `apply_preset(self, preset: QualityPreset) -> PipelineConfig` method to PipelineConfig:
    - Applies preset values to ReconstructionConfig and SparseMatchingConfig
    - Only overrides fields that haven't been explicitly set by user (check against defaults)
    - Returns self for chaining
    - Design choice: global preset with per-param override capability (per Claude's discretion)

    Add `depth_batch_size: int = 4` field to ReconstructionConfig -- controls batching in plane sweep (used by Plan 04 Task 2).

    Add model_validator to PipelineConfig: if quality_preset is set, auto-apply it after construction.

    Add tests to tests/test_config.py:
    - Test each preset sets expected values
    - Test explicit user values are NOT overridden by preset
    - Test preset round-trips through YAML
  </action>
  <verify>
    Run `pytest tests/test_config.py -v` -- all tests pass including new preset tests.
    Run `python -c "from aquamvs.config import QualityPreset, PipelineConfig; c = PipelineConfig(quality_preset='fast'); print(c.reconstruction.num_depths)"` -- prints 64.
  </verify>
  <done>
    QualityPreset enum with fast/balanced/quality presets. Each preset modifies num_depths, window_size, max_keypoints, voxel_size, poisson_depth, depth_batch_size. User overrides take precedence. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Plane sweep depth batching optimization</name>
  <files>
    src/aquamvs/dense/plane_sweep.py
    tests/test_dense/test_plane_sweep.py
  </files>
  <action>
    Optimize `build_cost_volume` in plane_sweep.py per research recommendation (batching depth hypotheses for better GPU utilization):

    Modify `build_cost_volume` signature to accept `batch_size: int = 1`:
    - Extract batch_size from config: `batch_size = getattr(config, 'depth_batch_size', 1)` (backward compatible if field not present)

    Replace the depth-by-depth loop with batched processing per research pattern 4:
    ```
    for batch_start in range(0, D, batch_size):
        batch_end = min(batch_start + batch_size, D)
        # Process all depths in batch
        for d_idx in range(batch_start, batch_end):
            depth = depths[d_idx].item()
            # Warp and compute cost as before
            ...
    ```

    The key optimization is NOT just restructuring the loop (that's cosmetic). The real optimization:
    1. Pre-allocate warped image buffers outside the loop to reduce allocations per research pitfall 3
    2. Ensure `torch.no_grad()` wraps the entire build (already added in Plan 03)
    3. For batch_size > 1: stack source warps for the batch and compute costs in a single vectorized operation where possible

    Keep the depth-by-depth path (batch_size=1) as fallback for memory-constrained scenarios (quality preset).

    Update `plane_sweep_stereo` to pass `config` (which now contains depth_batch_size) through to build_cost_volume.

    Add/update tests in `tests/test_dense/test_plane_sweep.py`:
    - Test that build_cost_volume produces identical results with batch_size=1 and batch_size=4
    - Test with batch_size that doesn't evenly divide num_depths (remainder handling)
    - Verify NaN handling is preserved with batching
  </action>
  <verify>
    Run `pytest tests/test_dense/test_plane_sweep.py -v` -- all tests pass.
    Run `pytest tests/test_dense/ -v` -- full dense stereo test suite passes.
  </verify>
  <done>
    build_cost_volume supports configurable depth batching. batch_size=1 (quality) produces identical results to original. batch_size=4/8 (balanced/fast) improves GPU utilization. Pre-allocated buffers reduce memory fragmentation. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `pytest tests/test_config.py tests/test_dense/ -v` -- all tests pass
- Quality presets apply correct parameter values
- Batched plane sweep produces identical results to unbatched (numerical correctness preserved)
- depth_batch_size field flows from config through to build_cost_volume
</verification>

<success_criteria>
- QualityPreset enum (fast/balanced/quality) modifies multiple config params with one setting
- Plane sweep build_cost_volume supports depth batching with configurable batch_size
- Batched results match unbatched results (correctness preserved)
- At least one optimization (depth batching + torch.no_grad) targets measured bottleneck (BEN-03)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-performance-and-optimization/05-04-SUMMARY.md`
</output>
