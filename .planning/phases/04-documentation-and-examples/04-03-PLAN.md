---
phase: 04-documentation-and-examples
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/theory/index.rst
  - docs/theory/refractive_geometry.rst
  - docs/theory/dense_stereo.rst
  - docs/theory/fusion.rst
autonomous: true

must_haves:
  truths:
    - "Theory section explains refractive multi-view stereo math from first principles"
    - "Diagrams illustrate ray casting, Snell's law refraction, plane sweep, and fusion"
    - "Theory documentation is reference-quality for researchers and advanced users"
  artifacts:
    - path: "docs/theory/index.rst"
      provides: "Theory section landing page and overview"
    - path: "docs/theory/refractive_geometry.rst"
      provides: "Ray casting and Snell's law refraction explanation with diagrams"
      contains: "mermaid"
    - path: "docs/theory/dense_stereo.rst"
      provides: "Plane sweep stereo and cost volume explanation"
      contains: "mermaid"
    - path: "docs/theory/fusion.rst"
      provides: "Multi-view depth fusion and surface reconstruction explanation"
  key_links:
    - from: "docs/theory/refractive_geometry.rst"
      to: "docs/api/calibration.rst"
      via: "cross-reference to calibration API"
      pattern: ":doc:"
    - from: "docs/theory/dense_stereo.rst"
      to: "docs/api/reconstruction.rst"
      via: "cross-reference to reconstruction API"
      pattern: ":doc:"
---

<objective>
Write detailed theory/concepts documentation explaining the refractive multi-view stereo pipeline math.

Purpose: Per user decision, this is a "detailed theory/concepts section: full walkthrough of refractive multi-view stereo math (ray casting, Snell's law refraction, plane sweep, cost volume, fusion) with diagrams. Reference-quality." This serves researchers who want to understand the mathematical foundations.

Output: Complete theory section with Mermaid diagrams covering the full reconstruction pipeline math.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@CLAUDE.md
@../AquaCal/dev/GEOMETRY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write refractive geometry theory page</name>
  <files>docs/theory/index.rst, docs/theory/refractive_geometry.rst</files>
  <action>
1. Create `docs/theory/index.rst`:
   ```rst
   Theory and Concepts
   ===================

   This section provides a detailed walkthrough of the mathematics behind
   AquaMVS's refractive multi-view stereo reconstruction pipeline. It covers
   the complete path from camera pixels to 3D surface meshes, with emphasis
   on the refractive ray model that distinguishes underwater reconstruction
   from standard multi-view stereo.

   .. toctree::
      :maxdepth: 2

      refractive_geometry
      dense_stereo
      fusion
   ```

2. Create `docs/theory/refractive_geometry.rst` with these sections:

   **Coordinate System** (~15 lines):
   - World frame: origin at reference camera optical center, +X right, +Y forward, +Z down (into water)
   - Camera frame: OpenCV convention (+X right, +Y down, +Z forward)
   - Extrinsics: p_cam = R @ p_world + t
   - Units: meters throughout

   **Camera Model** (~20 lines):
   - Pinhole projection with radial/tangential distortion
   - Undistortion preprocessing step
   - Intrinsic matrix K mapping 3D camera coords to pixels

   **Refractive Ray Casting** (~40 lines):
   - Problem: cameras in air, targets underwater, flat interface between
   - Step 1: Cast ray from camera through pixel (standard back-projection)
   - Step 2: Find intersection with water surface plane at z = water_z
   - Step 3: Apply Snell's law at interface: n_air * sin(theta_i) = n_water * sin(theta_r)
   - Step 4: Compute refracted ray direction below surface
   - Include Mermaid diagram showing the ray path:
     ```
     .. mermaid::

        graph TD
          A[Camera in Air] -->|"incident ray"| B[Water Surface z=water_z]
          B -->|"refracted ray (Snell's law)"| C[Underwater Target]
          style B fill:#4fc3f7,stroke:#0288d1
     ```
   - Mathematical derivation of Snell's law in vector form
   - Interface normal convention: [0, 0, -1] pointing from water toward air
   - Handle total internal reflection (validity mask)

   **Snell's Law Vector Form** (~30 lines):
   - Given incident ray d_i, normal n, refractive indices n1, n2
   - cos_i = -dot(n, d_i)
   - sin2_t = (n1/n2)^2 * (1 - cos_i^2)
   - If sin2_t > 1: total internal reflection (invalid)
   - d_t = (n1/n2) * d_i + ((n1/n2) * cos_i - sqrt(1 - sin2_t)) * n
   - Note connection to code: `aquacal.core.refractive_geometry`

   **Depth Parameterization** (~15 lines):
   - Ray depth d: distance along ray from origin (water surface intersection point for refractive model)
   - 3D point = origin + d * direction
   - World Z = origin_z + d * direction_z
   - Why ray depth (not world Z): depth along refracted ray is natural for plane sweep

   Include cross-references: `:doc:`/api/calibration`` for calibration data structures.

   Use proper RST math directives (`:math:` inline, `.. math::` display) for equations. Use Mermaid for architectural/flow diagrams.
  </action>
  <verify>Confirm file exists and contains math directives, mermaid directive, and covers all listed sections. If sphinxcontrib-mermaid is installed, verify `sphinx-build` renders the mermaid blocks without error.</verify>
  <done>Refractive geometry theory page explains coordinate system, camera model, Snell's law vector form, and depth parameterization with diagrams</done>
</task>

<task type="auto">
  <name>Task 2: Write dense stereo and fusion theory pages</name>
  <files>docs/theory/dense_stereo.rst, docs/theory/fusion.rst</files>
  <action>
1. Create `docs/theory/dense_stereo.rst` with these sections:

   **Overview** (~10 lines):
   - Goal: compute dense depth map for each reference camera
   - Two approaches: sparse triangulation + densification, or direct plane sweep stereo

   **Sparse Feature Matching** (~20 lines):
   - SuperPoint feature extraction on undistorted images
   - LightGlue matching between camera pairs
   - Cross-pair triangulation to get 3D points
   - Sparse cloud filtering (statistical outlier removal, percentile depth range)
   - Role: provides depth range priors for plane sweep

   **Plane Sweep Stereo** (~40 lines):
   - Core algorithm: evaluate photometric similarity at discrete depth hypotheses
   - For each reference pixel, for each depth d in [d_min, d_max]:
     1. Back-project reference pixel to 3D point at depth d (using refractive ray model)
     2. Project 3D point into each source camera (forward through Snell's law)
     3. Sample source image at projected location (bilinear interpolation)
     4. Compute photometric cost (NCC or census transform)
   - Cost volume: H x W x D tensor of matching costs
   - Include Mermaid diagram:
     ```
     .. mermaid::

        graph LR
          subgraph "Reference Camera"
            P[Pixel u,v]
          end
          subgraph "Depth Hypotheses"
            D1[d1] --> X1[3D Point]
            D2[d2] --> X2[3D Point]
            DN[dN] --> XN[3D Point]
          end
          subgraph "Source Cameras"
            S1[Source 1]
            S2[Source 2]
          end
          P --> D1
          P --> D2
          P --> DN
          X1 --> S1
          X1 --> S2
     ```
   - Winner-take-all depth selection: argmin over cost volume
   - Confidence from cost distribution (ratio of best to second-best)

   **Dense Matching Alternative** (~15 lines):
   - RoMa v2: dense correspondence field between image pairs
   - Provides per-pixel matches without plane sweep
   - Used for full pipeline mode with dense triangulation
   - Complementary to plane sweep (different accuracy/speed tradeoffs)

   Cross-reference: `:doc:`/api/reconstruction`` for function signatures.

2. Create `docs/theory/fusion.rst` with these sections:

   **Multi-View Depth Fusion** (~30 lines):
   - Problem: multiple cameras produce overlapping depth maps with inconsistencies
   - Geometric consistency filtering:
     1. For each pixel in reference depth map, back-project to 3D
     2. Project into each source camera
     3. Compare depths: if |d_ref - d_source| < threshold, mark consistent
     4. Count consistent views → consistency score
   - Pixels with consistency < min_views are filtered out
   - Include Mermaid diagram showing fusion pipeline:
     ```
     .. mermaid::

        flowchart LR
          DM1[Depth Map 1] --> GC[Geometric\nConsistency\nFilter]
          DM2[Depth Map 2] --> GC
          DMN[Depth Map N] --> GC
          GC --> FPC[Fused\nPoint Cloud]
          FPC --> OR[Outlier\nRemoval]
          OR --> SR[Surface\nReconstruction]
     ```

   **Point Cloud Generation** (~15 lines):
   - Back-project filtered depth maps to 3D points
   - Color from reference images
   - Statistical outlier removal (nb_neighbors, std_ratio)
   - Merging overlapping regions from multiple cameras

   **Surface Reconstruction** (~25 lines):
   - Three methods available:
     1. **Poisson**: Smooth, watertight surface from oriented point cloud. Best for smooth surfaces. Requires normal estimation.
     2. **Heightfield**: Grid-based reconstruction. Assumes roughly planar surface (good for water surface). Projects points to height grid, interpolates.
     3. **Ball Pivoting (BPA)**: Triangle mesh from point cloud. Preserves detail but sensitive to sampling density.
   - Mesh simplification: quadric decimation to target face count
   - Export formats: PLY, OBJ, STL, GLTF

   Cross-reference: `:doc:`/api/reconstruction`` for function signatures.

Use RST math directives for equations where appropriate (consistency threshold formula, NCC formula). Use Mermaid for flow/architecture diagrams.
  </action>
  <verify>Confirm both files exist with proper RST structure, math directives, and mermaid diagrams. Run `sphinx-build -W -b html docs/ docs/_build/html` — theory pages render without errors.</verify>
  <done>Dense stereo theory covers plane sweep algorithm, cost volume, and winner-take-all selection. Fusion theory covers geometric consistency, point cloud generation, and three surface reconstruction methods. Both include Mermaid diagrams.</done>
</task>

</tasks>

<verification>
1. `docs/theory/index.rst` links to all three theory pages
2. `docs/theory/refractive_geometry.rst` covers coordinate system, Snell's law, depth parameterization
3. `docs/theory/dense_stereo.rst` covers plane sweep, cost volume, sparse/dense matching
4. `docs/theory/fusion.rst` covers consistency filtering, fusion, surface reconstruction
5. All pages have Mermaid diagrams and RST math directives
6. `sphinx-build -W -b html docs/ docs/_build/html` passes
</verification>

<success_criteria>
- Theory section is reference-quality: covers complete pipeline math from first principles
- Diagrams illustrate key concepts (ray refraction, plane sweep, fusion pipeline)
- Cross-references link theory to API documentation
- Readable by researchers unfamiliar with the specific codebase
</success_criteria>

<output>
After completion, create `.planning/phases/04-documentation-and-examples/04-03-SUMMARY.md`
</output>
