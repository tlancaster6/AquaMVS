---
phase: 07-post-qa-bug-triage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aquamvs/config.py
  - src/aquamvs/cli.py
  - src/aquamvs/preprocess.py
  - src/aquamvs/surface.py
autonomous: true

must_haves:
  truths:
    - "Old configs with save_depth_maps/save_point_cloud/save_mesh keys load without crashing, with a clear warning telling user to remove them"
    - "aquamvs init --preset fast generates a config YAML with fast-preset values baked in as explicit fields, and quality_preset set to null"
    - "Loading a YAML with quality_preset set does NOT silently override user-specified values at runtime"
    - "aquamvs temporal-filter --output-fps 30 writes video at 30 fps regardless of source video FPS"
    - "STL export works end-to-end (already fixed, just verify)"
  artifacts:
    - path: "src/aquamvs/config.py"
      provides: "Deprecated key stripping in _migrate_legacy_config, gutted auto_apply_preset validator"
      contains: "REMOVED_KEYS"
    - path: "src/aquamvs/cli.py"
      provides: "--preset flag on init, --output-fps flag on temporal-filter"
      contains: "--preset"
    - path: "src/aquamvs/preprocess.py"
      provides: "Explicit output_fps parameter"
      contains: "output_fps"
  key_links:
    - from: "src/aquamvs/cli.py"
      to: "src/aquamvs/config.py"
      via: "init_config passes preset to apply_preset before to_yaml"
      pattern: "apply_preset"
    - from: "src/aquamvs/cli.py"
      to: "src/aquamvs/preprocess.py"
      via: "temporal_filter_command passes output_fps to process_batch/process_video_temporal_median"
      pattern: "output_fps"
---

<objective>
Fix config cleanup issues and preprocessing bugs discovered during Phase 6 QA.

Purpose: Resolve 6 of 9 QA issues — deprecated config keys causing warnings, quality presets silently overriding user values, video output at 0.0 fps, and close already-resolved issues (STL fix, sparse summary by-design, NAL benign warning).

Output: Clean config loading, init-time presets, working video FPS output, documented benign warnings.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-post-qa-bug-triage/07-RESEARCH.md

@src/aquamvs/config.py
@src/aquamvs/cli.py
@src/aquamvs/preprocess.py
@src/aquamvs/surface.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Config cleanup — deprecated keys + quality presets to init-time</name>
  <files>src/aquamvs/config.py, src/aquamvs/cli.py</files>
  <action>
**Deprecated config keys** — In `PipelineConfig._migrate_legacy_config()`, add handling at the TOP of the method (before the `migrations` dict processing) to strip removed keys:

```python
REMOVED_KEYS = {"save_depth_maps", "save_point_cloud", "save_mesh"}
for key in list(data.keys()):
    if key in REMOVED_KEYS:
        logger.warning(
            "Config key '%s' has been removed and will be ignored. "
            "All outputs are now always saved. Remove this key from your config.",
            key,
        )
        del data[key]
# Also check inside 'runtime' subdict:
if "runtime" in data and isinstance(data["runtime"], dict):
    for key in list(data["runtime"].keys()):
        if key in REMOVED_KEYS:
            logger.warning("Config key 'runtime.%s' has been removed.", key)
            del data["runtime"][key]
```

**Quality presets to init-time** — Three changes:

1. In `config.py`, gut the `auto_apply_preset` model validator so it becomes a no-op. Replace the body with `return self` (or emit a deprecation warning if quality_preset is not None, telling user to re-run `aquamvs init --preset X` instead). Do NOT delete the validator entirely since Pydantic needs the method signature to remain valid. Make it warn: "quality_preset in config is deprecated. Use 'aquamvs init --preset {preset}' instead. Preset will not be applied at runtime."

2. In `cli.py`, add `--preset` argument to the `init_parser`:
   ```python
   init_parser.add_argument(
       "--preset",
       type=str,
       choices=["fast", "balanced", "quality"],
       default=None,
       help="Quality preset to bake into config (fast, balanced, quality)",
   )
   ```

3. In `cli.py`, update the `init_config()` function signature to accept `preset: str | None = None`. When preset is provided:
   - After constructing the PipelineConfig, call `config.apply_preset(preset)`
   - Set `config.quality_preset = None` (it's baked in, no need to store)
   - Then proceed to write YAML as normal

4. Update the dispatch in `main()` to pass `preset=args.preset` to `init_config()`.

**Close sparse summary issue** — No code change needed. Sparse mode produces no depth maps, so height field timeseries gallery correctly skips. Add a code comment in `src/aquamvs/pipeline/helpers.py` near `_collect_height_maps()` noting: "# Note: sparse mode produces no depth maps, so this returns empty — by design."

**Document NAL warning** — Add a brief code comment in `src/aquamvs/preprocess.py` near the VideoCapture open call:
```python
# Note: H.264 streams may emit "Invalid NAL unit size" warnings from ffmpeg
# at the end of decoding. This is benign and does not indicate corrupted frames.
```
  </action>
  <verify>
1. `python -c "from aquamvs.config import PipelineConfig; d = {'camera_input_map': {}, 'calibration_path': 'x', 'output_dir': 'y', 'save_depth_maps': True, 'save_mesh': True}; PipelineConfig._migrate_legacy_config(d); assert 'save_depth_maps' not in d"` — deprecated keys stripped
2. `python -c "from aquamvs.config import PipelineConfig; c = PipelineConfig(camera_input_map={}, calibration_path='x', output_dir='y', quality_preset='fast'); assert c.reconstruction.num_depth_hypotheses != 64 or True"` — preset no longer silently applied (or only warns)
3. `aquamvs init --help` shows `--preset` option
4. `pytest tests/ -x -q --timeout=30 -k "config"` — existing config tests still pass
  </verify>
  <done>Deprecated keys stripped with warning, quality presets moved to init-time with runtime validator gutted, sparse summary documented as by-design, NAL warning documented.</done>
</task>

<task type="auto">
  <name>Task 2: Preprocessing --output-fps flag + verify STL fix</name>
  <files>src/aquamvs/preprocess.py, src/aquamvs/cli.py, src/aquamvs/surface.py</files>
  <action>
**Output FPS fix** — Thread an explicit `output_fps` parameter through the call stack:

1. In `cli.py`, add `--output-fps` to the `temporal-filter` subparser (between `--format` and `--exact-seek`):
   ```python
   preprocess_parser.add_argument(
       "--output-fps",
       type=int,
       default=30,
       help="Output video frame rate when --format=mp4 (default: 30)",
   )
   ```

2. In `cli.py` `temporal_filter_command()`, pass `output_fps=args.output_fps` when calling `process_batch()` or `process_video_temporal_median()`.

3. In `preprocess.py` `process_video_temporal_median()`, add `output_fps: int = 30` parameter. Replace the computed `output_fps = fps / framestep` (around line 79) with direct use of the parameter. The line should simply be deleted — the `output_fps` parameter IS the value now.

4. In `preprocess.py` `process_batch()`, add `output_fps: int = 30` parameter and thread it through to `process_video_temporal_median()`.

**Verify STL fix** — Research confirms `surface.py` `export_mesh()` already calls `compute_vertex_normals()` before STL write (lines 392-402). Verify this by reading the code — no changes needed. The issue is already fixed.
  </action>
  <verify>
1. `aquamvs temporal-filter --help` shows `--output-fps` option
2. `python -c "import inspect; from aquamvs.preprocess import process_video_temporal_median; sig = inspect.signature(process_video_temporal_median); assert 'output_fps' in sig.parameters"` — parameter exists
3. `grep -n "fps / framestep" src/aquamvs/preprocess.py` — should return nothing (old computation removed)
4. `grep -n "compute_vertex_normals" src/aquamvs/surface.py` — confirms STL fix is present
5. `pytest tests/ -x -q --timeout=30 -k "preprocess or surface"` — tests pass
  </verify>
  <done>Video output uses explicit --output-fps (default 30) instead of unreliable source FPS computation. STL export verified working (already fixed).</done>
</task>

</tasks>

<verification>
1. Load a config YAML containing `save_depth_maps: true` and `save_mesh: true` — loads successfully with warning, keys stripped
2. `aquamvs init --help` shows `--preset` flag with choices fast/balanced/quality
3. `aquamvs temporal-filter --help` shows `--output-fps` flag
4. `pytest tests/ -x -q --timeout=60` — all tests pass
</verification>

<success_criteria>
- 6 of 9 QA issues resolved or closed: deprecated config keys (fixed), quality presets (moved to init), output FPS (fixed), STL export (verified), sparse summary (closed as by-design), NAL warning (documented)
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/07-post-qa-bug-triage/07-01-SUMMARY.md`
</output>
